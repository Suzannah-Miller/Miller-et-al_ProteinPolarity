---
title: "Quantification of polarized and co-polarized cells for siRNA depletion data"
output: html_notebook
---

Loads saved classified data for siRNA depletion data to calculate percentages of polarized cells and co-polarized cells, do statistics, and make figures (Figure 6 and Supp. Figure S8).

Packages:
```{r}
library(readxl)
library(tidyverse)
library(ggbeeswarm)
library(outliers)
library(stats)
library(FSA)
```

Directory path:
```{r}
dirPath <- "/Your/Directory/Path/"
```

Load data:
```{r}
metricsCleanMcamOtherMcam488.Classified <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ThesisAndFirstSubmission/metricsClean_McamOtherAllMcam488_Thesis_20221104_Classifiedtest.csv", sep = ""))

metricsCleanMcamOtherMcam488 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ThesisAndFirstSubmission/metricsClean_McamOtherAllMcam488_Thesis_20221104test.csv", sep=""))

copolarization <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ThesisAndFirstSubmission/copolarization_OneEnd_Class_MCAM-488_20221104.csv", sep = ""))

identical(metricsCleanMcamOtherMcam488.Classified %>% dplyr::select(-comboGbmExtraTwo_MCAM2) %>% arrange(Object), 
          metricsCleanMcamOtherMcam488 %>% 
            arrange(Object) %>% 
            dplyr::mutate(Experiment = ifelse(Experiment == "20210723_KD1", "20210726_KD1", Experiment)))

copolarization %>% count(ManualScoreMcam)

annotation <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/allAnnotation20221101.csv", sep = ""))
# Problem with annotation file where date was not removed on 20220509KD. Should not affect ML because data was not grouped by condition and it was only used as part of str_detect.

excludeImages <- c("KD_EZR_MCAM_Myosin_Cov2_001.nd2", "KD_RhoA_Actin_Myosin_cov1_002.nd2", "KD_RDX_Myosin_cov1_003.nd2", "Cntr_EZR_MCAM_Actin_Cov2_007.nd2", "Cntr_RhoA_Actin_ROCK1_2_cov1_006")

metricsCleanMcamOtherMcam488 %>%
  filter(Experiment %in% "20210728_KD2") %>%
  count(Condition)
# No staining that requires co-polarization analysis
```

```{r}
xlabel <- data.frame(mainCondition = c("siCntr", "siEZR", "siRDX", "siMSN"), 
                     xlabel = factor(c("Control", "EZR", "RDX", "MSN"), levels = c("Control", "MSN", "EZR", "RDX")))
```

Remove data for extraneous knockdown conditions, different IF staining, excluded experiments, etc.
```{r}
metricsCleanMcamOtherMcam488.PreFilt.Classified <- metricsCleanMcamOtherMcam488.Classified %>%
  filter(!Image %in% excludeImages) %>% 
  filter(Exclude != "Omit" | is.na(Exclude)) %>% 
  filter(!str_detect(Replicate, "StainCD44"), 
           !str_detect(Replicate, "StainMCAMC"),
           !str_detect(Image, "RDX488")) %>% # Stained using rabbit MCAM antibody or no MCAM
  filter(str_detect(Condition, "StainMCAM-")) %>%
  filter(!experimentGroup %in% c("20210513KD")) %>% # Using manual scoring to estimate results
  filter(Experiment != "20210210_EzrinKD") %>% # Not a replicate condition
  filter(mainRep != "20211205_siRhoA") %>%  # This removes siRhoA images (not control siRNA images with MCAM-ROCK1/2 staining)
  filter(!str_detect(Experiment, "20211205_KD_RDX")) %>% # Images appeared to be mislabeled
  filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) # Not a replicate condition

metricsCleanMcamOtherMcam488.PreFilt.Classified %>% filter(experimentGroup == "20210406KD") %>% count(Coverslip)
metricsCleanMcamOtherMcam488.PreFilt.Classified %>% group_by(experimentGroup) %>% count(Experiment) %>% ungroup()

# Remove excluded experiments
metricsCleanMcamOtherMcam488.Classified.Filt <- metricsCleanMcamOtherMcam488.PreFilt.Classified %>%
  filter(!Image %in% excludeImages) %>% filter(Exclude != "Omit" | is.na(Exclude)) %>% 
  filter(!str_detect(Replicate, "StainCD44"), 
           !str_detect(Replicate, "StainMCAMC"),
           !str_detect(Image, "RDX488")) %>% # Stained using rabbit MCAM antibody or no MCAM
  filter(str_detect(Condition, "StainMCAM-")) %>%
  filter(!experimentGroup %in% c("20210513KD")) %>%
  filter(!Experiment %in% c("20210723_KD1", "20210726_KD1", "20210805_KD3")) %>%
  filter(Experiment != "20210210_EzrinKD") %>%
  filter(mainRep != "20211205_siRhoA") %>%  # This removes siRhoA images (not control siRNA images with MCAM-ROCK1/2 staining)
  filter(!str_detect(Experiment, "20211205_KD_RDX")) %>% # Control and KD conditions may have been mixed up 
  merge(xlabel, by = "mainCondition") %>%
  dplyr::mutate(Condition = str_remove(Condition, "20220509_")) %>% # Fix problem with annotation file
  dplyr::mutate(Condition = str_remove(Condition, "_KD.*")) %>%
  arrange(Experiment)

unique(metricsCleanMcamOtherMcam488.Classified.Filt$Condition)

metricsCleanMcamOtherMcam488.Classified.Filt %>% group_by(Experiment, Condition) %>% count(mainRep) %>% ungroup()

write_csv(metricsCleanMcamOtherMcam488.Classified.Filt, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/metricsCleanClassified_UsedInPlots_20231004_test.csv", sep=""))
write_csv(metricsCleanMcamOtherMcam488.PreFilt.Classified, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/metricsCleanClassified_PreFiltered_20231004_test2.csv", sep=""))

# Check against files from original submission
test1 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ThesisAndFirstSubmission/metricsCleanClassified_UsedInPlots.csv", sep=""))
test2 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/metricsCleanClassified_UsedInPlots_20231004.csv", sep=""))
test3 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/metricsCleanClassified_PreFiltered_20231004.csv", sep=""))
test4 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/metricsCleanClassified_PreFiltered_20231004_test.csv", sep=""))
test5 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/metricsCleanClassified_Filtered_20231004.csv", sep=""))

test6 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/metricsCleanClassified_UsedInPlots_20231004_test.csv", sep=""))
test7 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/metricsCleanClassified_PreFiltered_20231004_test2.csv", sep=""))

# Same results as the first time code was run:
identical(test2, test6)
identical(test4, test7)

# Check prefilt
all.equal(test3 %>% arrange(Object), test4 %>% arrange(Object))
test4 %>% count(Condition) # Condition naming not corrected until filt in current notebook
identical(test3 %>% arrange(Object) %>% dplyr::select(-Condition), test4 %>% arrange(Object) %>% dplyr::select(-Condition))

# Filt compared to original
test1 %>% filter(!Object %in% test2$Object) %>% count(Coverslip) # Removed Cov2 from 20210406KD (a different concentration of lipofectamine)
identical(test1 %>% filter(Object %in% test2$Object) %>% arrange(Object), test2 %>% arrange(Object))

identical(test2 %>% arrange(Object), test5 %>% arrange(Object) %>% dplyr::select(all_of(colnames(test2))))

# Filt compared to prefilt
identical(test2 %>% arrange(Object) %>% dplyr::select(all_of(colnames(test3))), test3 %>% filter(Object %in% test2$Object) %>% arrange(Object))
setdiff(colnames(test2), colnames(test3))
test3 %>% filter(!Object %in% test2$Object) %>% count(Experiment)

remove(test1)
remove(test2)
remove(test3)
remove(test4)
remove(test5)
remove(test6)
remove(test7)
```
Manually scored 20210513KD experiment (Cells were fixed in a 24-well plate and imaged in PBS, instead of mounted on slides).
From SumManualScoring20210513KD.Rmd:
```{r}
manualScoring <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/InputForML/manualScoringNoCopolar_20221104_New.csv", sep = ""))

manual0513clean <- manualScoring %>% filter(experimentGroup == "20210513KD") %>%
  filter(mainCondition %in% c("CellsOnly", "siCntr", "siMSN"))

# Check:
manualScoring %>% filter(experimentGroup == "20210513KD", !Object %in% manual0513clean$Object) %>% group_by(mainCondition) %>% count(Condition) %>% ungroup()
manual0513clean %>% group_by(mainCondition) %>% count(Condition) %>% ungroup()
manual0513clean %>% count(Image)

# No duplicate scores
sum(duplicated(manual0513clean$Object))
sum(duplicated(manual0513clean$Cell))

manual0513clean %>%
  filter(is.na(Segmentation)) %>%
  filter(!Image %in% excludeImages) %>% # Remove images that overlapped with other images
  filter(Exclude != "Omit" | is.na(Exclude), 
           !str_detect(Replicate, "StainCD44"), 
           !str_detect(Replicate, "StainMCAMC"),
           !str_detect(Image, "RDX488")) %>% # Stained using rabbit MCAM antibody or no MCAM
  filter(str_detect(Condition, "StainMCAM-")) %>%
  filter(mainCondition %in% c("CellsOnly", "siCntr", "siMSN")) %>%
  count(mainCondition)

perc0513 <- manual0513clean %>%
  filter(is.na(Segmentation)) %>%
  filter(!Image %in% excludeImages) %>% # Remove images that overlapped with other images
  filter(Exclude != "Omit" | is.na(Exclude), 
           !str_detect(Replicate, "StainCD44"), 
           !str_detect(Replicate, "StainMCAMC"),
           !str_detect(Image, "RDX488")) %>% # Stained using rabbit MCAM antibody or no MCAM
  filter(str_detect(Condition, "StainMCAM-")) %>%
  filter(mainCondition %in% c("siCntr", "siMSN")) %>%
  merge(xlabel, by = "mainCondition") %>%
  dplyr::select(ManualScoreMcam, mainCondition, mainRep, xlabel, experimentGroup) %>%
  dplyr::mutate(class = ManualScoreMcam) %>%
  dplyr::mutate_at("class", function(x){x = as.character(x)
                             x = ifelse(x == "BothEnds", "None", x)
                             x = factor(x, levels = c("OneEnd", "None"))}) %>%
  group_by(experimentGroup, mainCondition, mainRep, xlabel) %>%
  count(class) %>%
  dplyr::mutate(perc = n/(sum(n))*100, nTot = sum(n)) %>%
  ungroup() %>%
  filter(class == "OneEnd")

1 - perc0513$perc[perc0513$xlabel == "MSN"]/perc0513$perc[perc0513$xlabel == "Control"] # 28% decrease relative to control
```


```{r}
# Fix labeling of first experiment which was imaged on two different dates
metricsCleanMcamOtherMcam488.PreFilt.Classified %>% filter(experimentGroup == "202107KD") %>% group_by(Experiment) %>% count(mainRep) %>% ungroup()
metricsCleanMcamOtherMcam488.PreFilt.Classified %>%
  filter(experimentGroup == "202107KD") %>%
  filter(str_detect(Condition, "StainMCAM-")) %>%
  dplyr::mutate(mainRep = ifelse(mainRep == "20210723_siRDX", "20210726_siRDX", mainRep),
                experimentGroup = ifelse(Experiment == "20210726_KD1", "20210726_KD1", experimentGroup)) %>%
  dplyr::mutate(mainRep = ifelse(mainRep == "20210723_siCntr", "20210726_siCntr", mainRep), 
                experimentGroup = ifelse(Experiment == "20210728_KD2", "20210728_KD2", experimentGroup)) %>%
  dplyr::mutate(experimentGroup = ifelse(Experiment == "20210805_KD3", "20210805_KD3", experimentGroup)) %>%
  group_by(experimentGroup) %>%
  count(mainRep) %>%
  ungroup()

plotMcamPol.PreFilt <- metricsCleanMcamOtherMcam488.PreFilt.Classified %>%
  filter(str_detect(Condition, "StainMCAM-")) %>%
  dplyr::mutate(mainRep = ifelse(mainRep == "20210723_siRDX", "20210726_siRDX", mainRep),
                experimentGroup = ifelse(Experiment == "20210726_KD1", "20210726_KD1", experimentGroup)) %>%
  dplyr::mutate(mainRep = ifelse(mainRep == "20210723_siCntr", "20210726_siCntr", mainRep), 
                experimentGroup = ifelse(Experiment == "20210728_KD2", "20210728_KD2", experimentGroup)) %>%
  dplyr::mutate(experimentGroup = ifelse(Experiment == "20210805_KD3", "20210805_KD3", experimentGroup)) %>%
  merge(xlabel, by = "mainCondition") %>%
  dplyr::select(comboGbmExtraTwo_MCAM2, mainCondition, mainRep, xlabel, experimentGroup) %>%
  dplyr::mutate(class = comboGbmExtraTwo_MCAM2) %>%
  dplyr::mutate_at("class", function(x){x = as.character(x)
                             x = ifelse(x == "BothEnds", "None", x)
                             x = factor(x, levels = c("OneEnd", "None"))}) %>%
  group_by(experimentGroup, mainCondition, mainRep, xlabel) %>%
  count(class) %>%
  dplyr::mutate(perc = n/(sum(n))*100, nTot = sum(n)) %>%
  ungroup() %>%
  filter(class == "OneEnd")

# Check against original percentages
test <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ThesisAndFirstSubmission/PercentPolarizedMcam_Replicate.csv", sep = ""))
setdiff(test %>% dplyr::mutate(experimentGroup = ifelse(experimentGroup == "202107KD", "20210728_KD2", experimentGroup)), plotMcamPol.PreFilt)
setdiff(plotMcamPol.PreFilt, test %>% dplyr::mutate(experimentGroup = ifelse(experimentGroup == "202107KD", "20210728_KD2", experimentGroup)))

includeExclude <- data.frame(experimentGroup = c("20210406KD", "20210513KD", "20210726_KD1", "20210728_KD2", "20210805_KD3", "20211205KD", "20220509KD", "20220530KD"), include = c("Included", "Excluded", "Excluded", "Included", "Excluded", "Included", "Included", "Included")) 

plotAll <- rbind(plotMcamPol.PreFilt, perc0513) %>%
  merge(includeExclude, by = "experimentGroup")

# write_csv(plotAll, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PercentPolarizedMcam_Replicate_AllExperiments.csv", sep = ""))
test2 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PercentPolarizedMcam_Replicate_AllExperiments.csv", sep = ""))
all.equal(plotAll, test2)
identical(plotAll %>% mutate(xlabel = as.character(xlabel), class = as.character(class)), test2)

# Remove 20210513KD experiment (excluded because of differences in sample preparation for IF)
# Remove 20210805_KD3 (excluded because of small sample size < 200 cells, 1 coverslip)
plotMcamPol.PreFilt.Norm <- plotAll %>%
  filter(experimentGroup != "20210513KD", experimentGroup != "20210805_KD3") %>%
  dplyr::select(-xlabel, -n, -mainRep, -nTot, -include) %>%
  spread(mainCondition, perc) %>%
  dplyr::mutate(siEZR = siEZR/siCntr, siRDX = siRDX/siCntr, siMSN = siMSN/siCntr, siCntr = siCntr/siCntr) %>%
  gather(key = "mainCondition", value = "KD", -class, -experimentGroup) %>%
  merge(xlabel, by = "mainCondition") %>%
  merge(includeExclude, by = "experimentGroup") %>%
  filter(!is.na(KD))

# With 20210513KD included
plotMcamPol.PreFilt.Norm.0513 <- plotAll %>%
  dplyr::select(-xlabel, -n, -mainRep, -nTot, -include) %>%
  spread(mainCondition, perc) %>%
  dplyr::mutate(siEZR = siEZR/siCntr, siRDX = siRDX/siCntr, siMSN = siMSN/siCntr, siCntr = siCntr/siCntr) %>%
  gather(key = "mainCondition", value = "KD", -class, -experimentGroup) %>%
  merge(xlabel, by = "mainCondition") %>%
  merge(includeExclude, by = "experimentGroup") %>%
  filter(!is.na(KD))

setdiff(plotMcamPol.PreFilt.Norm.0513, plotMcamPol.PreFilt.Norm)

pairwise.t.test(plotMcamPol.PreFilt.Norm$KD, plotMcamPol.PreFilt.Norm$mainCondition, p.adjust.method = "none", pool.sd = F)

# Test for exclusion of outliers (Dixon's Q test)
# EZR KD. The Q value is calclated as gap/range
dEZR <- dixon.test(plotMcamPol.PreFilt.Norm$KD[plotMcamPol.PreFilt.Norm$xlabel == "EZR"])
dEZR # Highest value is an outlier (from 20210726_KD1)
dEZR[["statistic"]][["Q"]]
shapiro.test(plotMcamPol.PreFilt.Norm$KD[plotMcamPol.PreFilt.Norm$mainCondition == "siEZR"]) # Not normal when including outler, but the distribution is normal after removal of the outlier (see below).

# Outlier by Dixon test, but the distribution is not normal before or after removal of the outlier.
# MSN KD
dMSN <- dixon.test(plotMcamPol.PreFilt.Norm$KD[plotMcamPol.PreFilt.Norm$xlabel == "MSN"])
dMSN # Highest value is an outlier (from 20210726_KD1)
dMSN[["statistic"]][["Q"]]
shapiro.test(plotMcamPol.PreFilt.Norm$KD[plotMcamPol.PreFilt.Norm$mainCondition == "siMSN"])
# Not an outlier when considering 0513
dixon.test(plotMcamPol.PreFilt.Norm.0513$KD[plotMcamPol.PreFilt.Norm.0513$xlabel == "MSN"])

# Qcrit for N = 4 at the 95% confidence level is 0.829

# RDX KD
# No outlier
dixon.test(plotMcamPol.PreFilt.Norm$KD[plotMcamPol.PreFilt.Norm$xlabel == "RDX"])

remove(test)
remove(test2)
```

% MCAM polarization before normalizing to control siRNA:
```{r}
plotMcamPol <- metricsCleanMcamOtherMcam488.Classified.Filt %>%
  filter(str_detect(Condition, "StainMCAM-")) %>%
  dplyr::select(comboGbmExtraTwo_MCAM2, mainCondition, mainRep, xlabel, experimentGroup) %>%
  dplyr::mutate(class = comboGbmExtraTwo_MCAM2) %>%
  dplyr::mutate_at("class", function(x){x = as.character(x)
                             x = ifelse(x == "BothEnds", "None", x)
                             x = factor(x, levels = c("OneEnd", "None"))}) %>%
  group_by(experimentGroup, mainCondition, mainRep, xlabel) %>%
  count(class) %>%
  dplyr::mutate(perc = n/(sum(n))*100, nTot = sum(n)) %>%
  ungroup() %>%
  filter(class == "OneEnd")
  
# write_csv(plotMcamPol, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PercentPolarizedMcam_Replicate.csv", sep = ""))
test <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ThesisAndFirstSubmission/PercentPolarizedMcam_Replicate.csv", sep = ""))
setdiff(test, plotMcamPol) # Only change is 20210406EZR


bioMean <- plotMcamPol %>%
  group_by(mainCondition, xlabel) %>%
  summarize(mean = mean(perc), sd = sd(perc)) %>%
  ungroup()
# write_csv(bioMean, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PercentPolarizedMcam_BioMean.csv", sep = ""))
test2 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ThesisAndFirstSubmission/PercentPolarizedMcam_BioMean.csv", sep = ""))
setdiff(test2, bioMean)

ggplot() +
  geom_col(data = bioMean, aes(x = xlabel, y = mean),  position = position_dodge()) +
  geom_point(data = plotMcamPol, aes(x = xlabel, y = perc, shape = experimentGroup), 
             position = position_jitterdodge(dodge.width = .3, jitter.width = 0.1, jitter.height = 0),
            size = 2.5) +
  geom_errorbar(data = bioMean, aes(x = xlabel, ymin = mean-sd, ymax = mean+sd),
                position = position_dodge(width = .5), 
                width = 0.25,
                alpha = 0.5) +
  theme_classic() + 
  ylab("Polarized Cells (%)") +
  xlab("siRNA") +
  ggtitle("ML Classification of MCAM Polarization") +
  labs(shape = "Replicate") +
  theme(axis.title = element_text(size = 16),
        axis.text.y = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        title = element_text(size = 16))  

remove(test)
remove(test2)
```
Normalized to control siRNA:
```{r}
plotMcamPolNorm <- plotMcamPol %>%
  dplyr::select(-xlabel, -n, -mainRep, -nTot) %>%
  spread(mainCondition, perc) %>%
  dplyr::mutate(siEZR = siEZR/siCntr, siRDX = siRDX/siCntr, siMSN = siMSN/siCntr, siCntr = siCntr/siCntr) %>%
  gather(key = "mainCondition", value = "KD", -class, -experimentGroup) %>%
  merge(xlabel, by = "mainCondition") %>%
  filter(!is.na(KD)) 
# write_csv(plotMcamPolNorm, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PercentPolarizedMcam_Replicate_Norm.csv", sep = ""))
test <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ThesisAndFirstSubmission/PercentPolarizedMcam_Replicate_Norm.csv", sep = ""))
test3 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PercentPolarizedMcam_Replicate_Norm.csv", sep = ""))
setdiff(test, plotMcamPolNorm)
all.equal(plotMcamPolNorm, test3)
identical(plotMcamPolNorm$KD, test3$KD)

bioMeanNorm <- plotMcamPolNorm %>%
  group_by(mainCondition, xlabel) %>%
  summarize(mean = mean(KD), sd = sd(KD)) %>%
  ungroup()
# write_csv(bioMeanNorm, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PercentPolarizedMcam_BioMean_Norm.csv", sep = ""))
test2 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ThesisAndFirstSubmission/PercentPolarizedMcam_BioMean_Norm.csv", sep = ""))
setdiff(test2, bioMeanNorm)
test3 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PercentPolarizedMcam_BioMean_Norm.csv", sep = ""))
all.equal(bioMeanNorm, test3)
identical(bioMeanNorm$mean, test3$mean)

ggplot() +
  geom_col(data = bioMeanNorm, aes(x = xlabel, y = mean),  position = position_dodge(), width = 0.5) +
  geom_point(data = plotMcamPolNorm, aes(x = xlabel, y = KD, shape = experimentGroup), 
             position = position_jitterdodge(dodge.width = .3, jitter.width = 0.1, jitter.height = 0),
            size = 2.5) +
  geom_errorbar(data = bioMeanNorm, aes(x = xlabel, ymin = mean-sd, ymax = mean+sd),
                position = position_dodge(width = .5), 
                width = 0.25,
                alpha = 0.5) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  theme_classic() + 
  ylab("Polarized Cells (%)") +
  xlab("siRNA") +
  ggtitle("ML Classification of MCAM Polarization") +
  labs(shape = "Replicate") +
  theme(axis.title = element_text(size = 16),
        axis.text.y = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        title = element_text(size = 16))

## Plot without shape = simpleRepNum
clr <- c("Control" = "#FFFFFF", "MSN" = "#b1b1b1", "EZR" = "#b1b1b1", "RDX" = "#b1b1b1")
ggplot() +
  geom_col(data = bioMeanNorm, aes(x = xlabel, y = mean, fill = xlabel), position = position_dodge(), width = 0.6, color = "black") +
  geom_point(data = plotMcamPolNorm %>%
               filter(mainCondition != "siCntr"), aes(x = xlabel, y = KD, fill = experimentGroup),
             position = position_jitterdodge(dodge.width = .3, jitter.width = 0.1, jitter.height = 0),
            size = 2) +
  geom_errorbar(data = bioMeanNorm %>% filter(mainCondition != "siCntr"), aes(x = xlabel, ymin = mean-sd, ymax = mean+sd),
                position = position_dodge(width = .6), 
                width = 0.4,
                alpha = 0.6,
                size = 1) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  theme_classic() + 
  ylab("Polarized Cells (%)") +
  xlab("siRNA") +
  ggtitle("ML Classification of MCAM Polarization") +
  scale_y_continuous(breaks = seq(0,1.2,.2)) +
  scale_fill_manual(values = clr) +
  theme(axis.title = element_text(size = 14),
        axis.text.y = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        title = element_text(size = 10),
        legend.position = "none")
# ggsave(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/PolarizedMcamKD_Norm_No0421Cov2_Paper.svg", sep = ""), width = 3, height = 3.5, units = "in", dpi = 600)
```

Statistics:
```{r}
## Check normality (assuming unequal variances because all controls == 1)
qqnorm(plotMcamPolNorm$KD[plotMcamPolNorm$mainCondition == "siMSN"])
qqnorm(plotMcamPolNorm$KD[plotMcamPolNorm$mainCondition == "siEZR"])
qqnorm(plotMcamPolNorm$KD[plotMcamPolNorm$mainCondition == "siRDX"])

shapiro.test(plotMcamPolNorm$KD[plotMcamPolNorm$mainCondition == "siMSN"]) # Not normal
shapiro.test(plotMcamPolNorm$KD[plotMcamPolNorm$mainCondition == "siEZR"])
shapiro.test(plotMcamPolNorm$KD[plotMcamPolNorm$mainCondition == "siRDX"])

tCntrMsn <- t.test(plotMcamPolNorm$KD[plotMcamPolNorm$mainCondition == "siMSN"],mu=1)
tCntrEzr <- t.test(plotMcamPolNorm$KD[plotMcamPolNorm$mainCondition == "siEZR"],mu=1)
tCntrRdx <- t.test(plotMcamPolNorm$KD[plotMcamPolNorm$mainCondition == "siRDX"], mu=1)
tEzrMsn <- t.test(plotMcamPolNorm$KD[plotMcamPolNorm$mainCondition == "siMSN"],plotMcamPolNorm$KD[plotMcamPolNorm$mainCondition == "siEZR"],paired = F)
tRdxEzr <- t.test(plotMcamPolNorm$KD[plotMcamPolNorm$mainCondition == "siEZR"],plotMcamPolNorm$KD[plotMcamPolNorm$mainCondition == "siRDX"],paired = F)
tMsnRdx <- t.test(plotMcamPolNorm$KD[plotMcamPolNorm$mainCondition == "siRDX"],plotMcamPolNorm$KD[plotMcamPolNorm$mainCondition == "siMSN"],paired = F)

p.adjust(c(tCntrMsn[["p.value"]], tCntrEzr[["p.value"]], tCntrRdx[["p.value"]], tEzrMsn[["p.value"]], tRdxEzr[["p.value"]], tMsnRdx[["p.value"]]), method = "holm")
tPerMcam <- pairwise.t.test(plotMcamPolNorm$KD, plotMcamPolNorm$mainCondition, p.adjust.method = "holm", pool.sd = F)
tPerMcam
pairwise.t.test(plotMcamPolNorm$KD, plotMcamPolNorm$mainCondition, p.adjust.method = "none", pool.sd = F)
```
Note: shapiro test was significant for siMSN

Sample size = 
```{r}
# write_csv(metricsCleanMcamOtherMcam488.Classified.Filt %>%
#    count(mainCondition), paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/SampleSize_McamPolarization_Condition.csv", sep = ""))
# 
# write_csv(metricsCleanMcamOtherMcam488.Classified.Filt %>%
#    count(mainRep), paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/SampleSize_McamPolarization_Replicate.csv", sep = ""))

test <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ThesisAndFirstSubmission/PaperFigures/SampleSize_McamPolarization_Replicate.csv", sep = ""))

setdiff(test, metricsCleanMcamOtherMcam488.Classified.Filt %>%
   count(mainRep))
metricsCleanMcamOtherMcam488.Classified.Filt %>%
    count(mainRep)
test

remove(test)
remove(test2)
```

```{r}
twoChannelExperiments <- c("20210513_MoesinKD", "20210210_EzrinKD", "20210406_KD", "20210723_KD1", "20210726_KD1", "20210728_KD2")

copolarizationLabeled <- copolarization %>%
  dplyr::mutate(Condition = str_remove(Condition, "20220509_")) %>% # Fix problem with annotation file
  dplyr::mutate(Condition = str_remove(Condition, "_KD.*")) %>%
  filter(!Image %in% excludeImages) %>% filter(Exclude != "Omit" | is.na(Exclude)) %>% 
  filter(!str_detect(Replicate, "StainCD44"), 
           !str_detect(Replicate, "StainMCAMC"),
           !str_detect(Image, "RDX488")) %>% # Stained using rabbit MCAM antibody or no MCAM
  filter(str_detect(Condition, "StainMCAM-")) %>%
  filter(!experimentGroup %in% c("20210513KD")) %>%
  filter(!Experiment %in% c("20210723_KD1", "20210726_KD1", "20210805_KD3")) %>%
  filter(Experiment != "20210210_EzrinKD") %>%
  filter(mainRep != "20211205_siRhoA") %>%  # This removes siRhoA images (not control siRNA images with MCAM-ROCK1/2 staining)
  filter(!str_detect(Experiment, "20211205_KD_RDX")) %>% 
  filter(is.na(Segmentation)) %>% # Remove bad classifications/out of focus cells/cells with bad segmentation
  filter(!str_detect(Condition, "StainMCAM-RDX")) %>%
  filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) %>%
  dplyr::mutate(copolarOther = ifelse(ManualScoreOther!="None" & is.na(SameSideOther), 1, 0),
                copolarFactin = ifelse(!Experiment %in% twoChannelExperiments, ifelse(ManualScoreFactin!="None" & is.na(SameSideFactin), 1, 0), NA),
                copolarTriple = ifelse(!Experiment %in% twoChannelExperiments, ifelse((copolarOther == 1 & copolarFactin == 1), 1, 0), NA),
                stain = str_remove(Condition, ".*Stain")) %>%
  dplyr::mutate(stain = str_remove(stain, "_KD.*")) %>%
  merge(xlabel, by = "mainCondition")
# write_csv(copolarizationLabeled,  paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/copolarizationLabeled_20231004_test.csv", sep = ""))
test1 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/copolarizationLabeled_20231004.csv", sep = ""))
test2 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ThesisAndFirstSubmission/copolarizationLabeled.csv", sep = ""))
test2 %>% filter(!Object %in% test1$Object) %>% count(Coverslip) # Removed 20210406KD "Cov2"
identical(test1 %>% arrange(Object), test2 %>% filter(Object %in% test1$Object) %>% arrange(Object))
identical(test1 %>% arrange(Object), test2 %>% filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) %>% arrange(Object))
all.equal(test1, copolarizationLabeled)
test3 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/copolarizationLabeled_20231004_test.csv", sep = ""))
identical(test1, test3)
remove(test1)
remove(test2)
remove(test3)

copolarizationLabeled %>% count(Coverslip)

setdiff(copolarization %>% filter(is.na(Segmentation), !str_detect(Condition, "StainMCAM-RDX")) %>% dplyr::select(-Condition), copolarizationLabeled %>% dplyr::select(colnames(copolarization), -Condition)) %>% count(Experiment)
setdiff(copolarization %>% filter(is.na(Segmentation)) %>% dplyr::select(-Condition), copolarizationLabeled %>% dplyr::select(colnames(copolarization), -Condition)) %>% filter(Experiment == "20211205_KD_EZR_RepN") # Excluded image
copolarizationLabeled %>% group_by(Condition, stain) %>% count() %>% ungroup()

# These figures should be unaffected by correction of 20210406KD
copolar1rep <- copolarizationLabeled %>%
  filter(experimentGroup == "20220509KD") %>%
  filter(str_detect(Condition, "StainMCAM-EZR")|str_detect(Condition, "StainMCAM-MSN")) %>%
  group_by(mainCondition, xlabel, experimentGroup, stain) %>%
  count(copolarOther) %>%
  dplyr::mutate(perc = n/(sum(n))*100, nTot = sum(n)) %>%
  ungroup() %>%
  dplyr::mutate(stain = str_remove(str_remove(stain, "Stain"), "-Factin")) %>%
  dplyr::mutate(stain = factor(stain, levels = c("MCAM-MSN", "MCAM-EZR")))

copolar2rep <- copolarizationLabeled %>%
  filter(experimentGroup %in% c("20220509KD", "20220530KD")) %>%
  filter(str_detect(Condition, "StainMCAM-EZR")|str_detect(Condition, "StainMCAM-MSN")) %>%
  group_by(mainCondition, xlabel, experimentGroup, stain) %>%
  count(copolarOther) %>%
  dplyr::mutate(perc = n/(sum(n))*100, nTot = sum(n)) %>%
  ungroup() %>%
  dplyr::mutate(stain = str_remove(str_remove(stain, "Stain"), "-Factin")) %>%
  dplyr::mutate(stain = factor(stain, levels = c("MCAM-MSN", "MCAM-EZR")))
copolar2repMean <- copolar2rep %>%
  filter(copolarOther == 1) %>%
  group_by(xlabel, stain) %>%
  summarize(meanCopolar = mean(perc)) %>%
  ungroup()

clrEzrMsn = c("MCAM-MSN" = "#5e3c99", "MCAM-EZR" = "#e66101") 
ggplot(copolar1rep %>% filter(copolarOther == 1)) + geom_col(aes(x = xlabel, y = perc, fill = stain), position = position_dodge(), width = .5) +
  theme_classic() + 
  ylab("Co-polarized Cells (%)") +
  xlab("siRNA") +
  #labs(shape = "Replicate") +
  theme(axis.title = element_text(size = 14),
        axis.text.y = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        title = element_text(size = 14)) +
  scale_fill_manual(values = clrEzrMsn)
# ggsave(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/copolarEzrMsn_1rep.svg", sep = ""), width = 6, height = 3, units = "in", dpi = 600)

ggplot() +
  geom_col(data = copolar2repMean, aes(x = xlabel, y = meanCopolar, fill = stain),  position = position_dodge(), width = 0.5) +
        geom_point(data = copolar2rep %>% filter(copolarOther == 1), aes(x = xlabel, y = perc, fill = experimentGroup, group = stain),
                   position = position_quasirandom(dodge.width = .5, groupOnX = T),
                  size = 1.5) +
  theme_classic() + 
  ylab("Co-polarized Cells (%)") +
  xlab("siRNA") +
  #labs(shape = "Replicate") +
  theme(axis.title = element_text(size = 14),
        axis.text.y = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        title = element_text(size = 14)) +
  scale_fill_manual(values = clrEzrMsn)
# ggsave(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/copolarEzrMsn_2rep.svg", sep = ""), width = 6, height = 3, units = "in", dpi = 600)

# write_csv(copolar1rep %>% group_by(xlabel, stain) %>% summarize(sum(n)), paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/SampleSize_copolar1Rep.csv", sep = ""))

# write_csv(copolar2rep %>% group_by(xlabel, stain) %>% summarize(sum(n)), paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/SampleSize_copolar2Rep.csv", sep = ""))
test <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ThesisAndFirstSubmission/PaperFigures/SampleSize_copolar2Rep.csv", sep = ""))
test
copolar2rep %>% group_by(xlabel, stain) %>% summarize(sum(n))
remove(test)
```


Intensity of MCAM normalized to median of control siRNA (Supplemental Figure 8A):
```{r}
repClr <- c("1" = "#fb8072", "2" = "#80b1d3", "3" = "#fdb462", "4" = "#bebada", "5" = "#A3D393", "6" = "#b2182b")
mcamIntensity <- metricsCleanMcamOtherMcam488.Classified.Filt %>%
  filter(str_detect(Condition, "StainMCAM")) 

mcamIntensityMedian <- mcamIntensity %>%
  filter(xlabel == "Control") %>%
  group_by(experimentGroup) %>%
  summarize(medianMeanIntensityMcam = median(meanIntensityCell_MCAM)) %>% ungroup()
  
experiments <- unique(metricsCleanMcamOtherMcam488.Classified.Filt$experimentGroup)

mcamIntensityNorm <- mcamIntensity %>%
  dplyr::select(Condition, xlabel, meanIntensityCell_MCAM, experimentGroup, comboGbmExtraTwo_MCAM2, mainRep) %>%
  dplyr::mutate(meanIntensityCell_Mcam_Norm = ifelse(experimentGroup == experiments[1], meanIntensityCell_MCAM/mcamIntensityMedian$medianMeanIntensityMcam[mcamIntensityMedian$experimentGroup == experiments[1]],
                                                     ifelse(experimentGroup == experiments[2],  meanIntensityCell_MCAM/mcamIntensityMedian$medianMeanIntensityMcam[mcamIntensityMedian$experimentGroup == experiments[2]],
                                                            ifelse(experimentGroup == experiments[3], meanIntensityCell_MCAM/mcamIntensityMedian$medianMeanIntensityMcam[mcamIntensityMedian$experimentGroup == experiments[3]],
                                                                   ifelse(experimentGroup == experiments[4], meanIntensityCell_MCAM/mcamIntensityMedian$medianMeanIntensityMcam[mcamIntensityMedian$experimentGroup == experiments[4]], 
                                                                          ifelse(experimentGroup == experiments[5], meanIntensityCell_MCAM/mcamIntensityMedian$medianMeanIntensityMcam[mcamIntensityMedian$experimentGroup == experiments[5]], NA)))))) %>%
  dplyr::mutate(experimentGroup = factor(experimentGroup, levels = c("20211205KD", "202107KD", "20220530KD", "20210406KD", "20220509KD"))) %>%
  arrange(experimentGroup)

sum(is.na(mcamIntensityNorm$meanIntensityCell_Mcam_Norm))
mcamIntensityNorm %>%
  filter(xlabel == "Control") %>%
  group_by(experimentGroup) %>%
  summarize(median(meanIntensityCell_Mcam_Norm))

library(RColorBrewer)
ggplot(mcamIntensityNorm, aes(x = xlabel, y = meanIntensityCell_Mcam_Norm, color = experimentGroup)) +
  geom_violin(draw_quantiles = c(.25,.5,.75), scale = "area",
              position = position_dodge(width = .7),
              size = .8) +
  theme_classic() + 
  ylab("Mean Intensity") +
  xlab("siRNA") +
  ggtitle("Anti-MCAM") +
  #labs(shape = "Replicate") +
  theme(axis.title = element_text(size = 14),
        axis.text.y = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        title = element_text(size = 16),
        legend.position = "none") +
  scale_color_brewer(palette = "Dark2")

mcamIntensityNormMedians <- mcamIntensityNorm %>%
  group_by(experimentGroup, xlabel) %>%
  summarize(medianExpression = median(meanIntensityCell_Mcam_Norm)) %>% ungroup()

ggplot(mcamIntensityNorm) + 
  geom_beeswarm(data = NULL, aes(x = xlabel, y = meanIntensityCell_Mcam_Norm,color = experimentGroup), cex = .2, dodge.width = .7, alpha = 0.25, size = 1.2, show.legend = T) +
  geom_boxplot(data = NULL, aes(x = xlabel, y = meanIntensityCell_Mcam_Norm, fill = experimentGroup), width = 0.4, position = position_dodge(width = .7), outlier.shape = NA, alpha = 0, size = 0.6) +
  # geom_point(data = mcamIntensityNormMedians, aes(x = xlabel, y = medianExpression, fill = experimentGroup),
  #            position = position_quasirandom(dodge.width = 0.2, groupOnX=T),
  #            size = 2.5, shape = 24, alpha = 0.9) +
  theme_classic() + ylab("Normalized Mean Intensity (A.U.)") +
  xlab("siRNA") +
  scale_y_continuous(breaks = seq(0,10,1)) +
  theme(legend.position = "none", 
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 18)) +
  scale_color_brewer(palette = "Dark2") #+
  #scale_fill_brewer(palette = "Dark2")

# ggsave(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/MeanIntensityNorm_MCAM_newClr_No0406Cov2_20230317_V2.svg", sep = ""), width = 6, height = 3.5, units = "in", dpi = 600)

mcamIntensityNorm %>% group_by(xlabel) %>% count()
# write_csv(mcamIntensityNorm %>% group_by(xlabel) %>% count(), paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/SampleSize_MeanIntensityNorm_Condition.csv", sep = ""))
mcamIntensityNorm %>% group_by(xlabel, experimentGroup) %>% count()
# write_csv(mcamIntensityNorm %>% group_by(xlabel, experimentGroup) %>% count(), paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/SampleSize_MeanIntensityNorm_Replicate.csv", sep = ""))

for(val in 1:5){
  x <- mcamIntensityNorm %>%
             filter(xlabel %in% c("Control", "MSN", "EZR", "RDX"), experimentGroup == experiments[val], str_detect(Condition, "StainMCAM")) %>%
    dplyr::select(xlabel, meanIntensityCell_Mcam_Norm)
  print(experiments[val])
  if(length(unique(x$xlabel)) > 2){
    print(kruskal.test(meanIntensityCell_Mcam_Norm ~ xlabel, data = x))
    DT <- dunnTest(x$meanIntensityCell_Mcam_Norm, x$xlabel, method = "holm")
    print(DT)
  }else{
    print(wilcox.test(meanIntensityCell_Mcam_Norm ~ xlabel, data = x))
  }
}
```
Supplemental Figure 8B:
```{r}
foldchangeMedian <- metricsCleanMcamOtherMcam488.Classified.Filt %>%
  filter(comboGbmExtraTwo_MCAM2=="OneEnd") %>% # polarized cells
  group_by(xlabel, experimentGroup, mainRep) %>%
  summarize(medianChange = median(meanWrampOverNot_MCAM)) %>%
  ungroup() %>%
  dplyr::mutate(experimentGroup = factor(experimentGroup, levels = c("20211205KD", "202107KD", "20220530KD", "20210406KD", "20220509KD"))) %>%
  arrange(experimentGroup)

ggplot(metricsCleanMcamOtherMcam488.Classified.Filt %>% 
         filter(comboGbmExtraTwo_MCAM2=="OneEnd") %>%
         dplyr::mutate(experimentGroup = factor(experimentGroup, levels = c("20211205KD", "202107KD", "20220530KD", "20210406KD", "20220509KD"))) %>%
         arrange(experimentGroup)) + 
  geom_beeswarm(data = NULL, aes(x = xlabel, y = meanWrampOverNot_MCAM, group = xlabel, color = experimentGroup),
                cex = .36, dodge.width = .6, alpha = 0.3, size = 1.5) +
  geom_boxplot(data = NULL, aes(x = xlabel, y = meanWrampOverNot_MCAM, group = xlabel), width = 0.6, position = position_dodge(width = .5), outlier.shape = NA, alpha = 0, size = 0.6) +
  geom_point(data = foldchangeMedian, aes(x = xlabel, y = medianChange, fill = experimentGroup), 
             position = position_quasirandom(dodge.width = 0.2, groupOnX=T),
             size = 3, shape = 24, alpha = 0.9) +
  theme_classic() + ylab("Fold-Change Intensity") +
  xlab("siRNA") +
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 18)) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2")

# ggsave(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/meanWrampOverNot_MCAM_No0406Cov2.svg", sep = ""), width = 4.3, height = 3.5, units = "in", dpi = 600)
# write_csv(metricsCleanMcamOtherMcam488.Classified.Filt %>% filter(comboGbmExtraTwo_MCAM2 == "OneEnd") %>% group_by(xlabel) %>% count(experimentGroup) %>% ungroup(), paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/meanWrampOverNot_MCAM_No0406Cov2_SampleSize.csv", sep = ""))

ggplot(metricsCleanMcamOtherMcam488.Classified.Filt %>% 
         filter(comboGbmExtraTwo_MCAM2=="OneEnd") %>%
         dplyr::mutate(experimentGroup = factor(experimentGroup, levels = c("20211205KD", "202107KD", "20220530KD", "20210406KD", "20220509KD"))) %>%
         arrange(experimentGroup)) + 
  geom_beeswarm(data = NULL, aes(x = xlabel, y = meanWrampOverNot_MCAM, color = experimentGroup),
                cex = .32, dodge.width = .7, alpha = 0.3, size = 1.5) +
  geom_boxplot(data = NULL, aes(x = xlabel, y = meanWrampOverNot_MCAM, fill = experimentGroup), width = 0.4, position = position_dodge(width = .7), outlier.shape = NA, alpha = 0, size = 0.6) +
  # geom_point(data = foldchangeMedian, aes(x = xlabel, y = medianChange, fill = experimentGroup), 
  #            position = position_quasirandom(dodge.width = 0.2, groupOnX=T),
  #            size = 3, shape = 24, alpha = 0.9) +
  theme_classic() + ylab("Fold-Change Intensity") +
  xlab("siRNA") +
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 18)) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2")
# ggsave(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/meanWrampOverNot_MCAM_No0406Cov2_V2.svg", sep = ""), width = 5, height = 3.2, units = "in", dpi = 600)

ggplot(metricsCleanMcamOtherMcam488.Classified.Filt %>% 
         filter(comboGbmExtraTwo_MCAM2=="OneEnd") %>%
         dplyr::mutate(experimentGroup = factor(experimentGroup, levels = c("20211205KD", "202107KD", "20220530KD", "20210406KD", "20220509KD"))) %>%
         arrange(experimentGroup)) + 
  geom_violin(aes(x = xlabel, y = meanWrampOverNot_MCAM, color = experimentGroup), scale = "count", draw_quantiles = c(.25,.5,.75))
                

ggplot(metricsCleanMcamOtherMcam488.Classified.Filt %>%
  filter(comboGbmExtraTwo_MCAM2=="OneEnd"), aes(x = meanIntensityCell_MCAM, y = meanWrampOverNot_MCAM)) + geom_point(alpha = 0.4) + facet_grid(cols = vars(xlabel), rows = vars(experimentGroup))
# Not a strong dependence on expression

for(val in 1:5){
  x <- metricsCleanMcamOtherMcam488.Classified.Filt %>%
    filter(comboGbmExtraTwo_MCAM2 == "OneEnd") %>%
             filter(xlabel %in% c("Control", "MSN", "EZR", "RDX"), experimentGroup == experiments[val], str_detect(Condition, "StainMCAM")) %>%
    dplyr::select(xlabel, meanWrampOverNot_MCAM)
  print(experiments[val])
  if(length(unique(x$xlabel)) > 2){
    print(kruskal.test(meanWrampOverNot_MCAM ~ xlabel, data = x))
    DT <- dunnTest(x$meanWrampOverNot_MCAM, x$xlabel, method = "holm")
    print(DT)
  }else{
    print(wilcox.test(meanWrampOverNot_MCAM ~ xlabel, data = x))
  }
}
```

Make a function to plot % co-polarized cells:
```{r}
plotCopolar <- function(copolarizationData, conditionFilt, xlabelFilt, expGroups, titleName){
    copolarData <- copolarizationData %>%
      filter(str_detect(Condition, conditionFilt),
             xlabel %in% xlabelFilt,
             experimentGroup %in% expGroups) %>%
      group_by(xlabel, experimentGroup, mainRep) %>%
      count(copolarOther) %>%
      dplyr::mutate(perc = n/(sum(n))*100, nTot = sum(n)) %>%
      ungroup()
    
    copolarMean <- copolarData %>%
      filter(copolarOther == 1) %>%
      group_by(xlabel) %>%
      summarize(meanCopolar = mean(perc),
                sdCopolar = sd(perc))
    
    if(length(expGroups) < 3){
      print(ggplot() +
        geom_col(data = copolarMean, aes(x = xlabel, y = meanCopolar, fill = xlabel),  position = position_dodge(), width = 0.6, color = "black") +
        geom_point(data = copolarData %>% filter(copolarOther == 1), aes(x = xlabel, y = perc, fill = experimentGroup),
                   position = position_jitterdodge(dodge.width = .3, jitter.width = 0.1, jitter.height = 0),
                  size = 2) +
        #geom_errorbar(data = copolarMean, aes(x = xlabel, ymin = meanCopolar-sdCopolar, ymax = meanCopolar+sdCopolar),
                      # position = position_dodge(width = .5), 
                      # width = 0.25,
                      # alpha = 0.5) +
        theme_classic() + 
        ylab("Co-polarized Cells (%)") +
        xlab("siRNA") +
        ggtitle(titleName) +
        #labs(shape = "Replicate") +
          scale_fill_manual(values = clr) +
        theme(axis.title = element_text(size = 14),
              axis.text.y = element_text(size = 14),
              axis.text.x = element_text(size = 12),
              title = element_text(size = 14),
              legend.position = "none")+
          ylim(0,105))
    }else{
      print(ggplot() +
      geom_col(data = copolarMean, aes(x = xlabel, y = meanCopolar, fill = xlabel),  position = position_dodge(), width = 0.6, color = "black") +
      geom_point(data = copolarData %>% filter(copolarOther == 1), aes(x = xlabel, y = perc, fill = experimentGroup),
                 position = position_jitterdodge(dodge.width = .3, jitter.width = 0.1, jitter.height = 0),
                size = 2) +
      geom_errorbar(data = copolarMean, aes(x = xlabel, ymin = meanCopolar-sdCopolar, ymax = meanCopolar+sdCopolar),
                    position = position_dodge(width = .6), 
                    width = 0.4,
                    alpha = 0.6) +
        scale_fill_manual(values = clr) +
      theme_classic() + 
      ylab("Co-polarized Cells (%)") +
      xlab("siRNA") +
      ggtitle(titleName) +
      #labs(shape = "Replicate") +
      theme(axis.title = element_text(size = 14),
            axis.text.y = element_text(size = 14),
            axis.text.x = element_text(size = 12),
            title = element_text(size = 14),
            legend.position = "none")+
        ylim(0,105))
    }
    
    return(copolarData)
}



plotCopolarThird <- function(copolarizationData, conditionFilt, xlabelFilt, expGroups, titleName){
    copolarData <- copolarizationData %>%
      filter(str_detect(Condition, conditionFilt),
             xlabel %in% xlabelFilt,
             experimentGroup %in% expGroups) %>%
      group_by(xlabel, experimentGroup, mainRep) %>%
      count(copolarFactin) %>%
      dplyr::mutate(perc = n/(sum(n))*100, nTot = sum(n)) %>%
      ungroup()
    
    copolarMean <- copolarData %>%
      filter(copolarFactin == 1) %>%
      group_by(xlabel) %>%
      summarize(meanCopolar = mean(perc),
                sdCopolar = sd(perc))
    
    if(length(expGroups) < 3){
      print(ggplot() +
        geom_col(data = copolarMean, aes(x = xlabel, y = meanCopolar, fill = xlabel),  position = position_dodge(), width = 0.6, color = "black") +
        geom_point(data = copolarData %>% filter(copolarFactin == 1), aes(x = xlabel, y = perc, fill = experimentGroup),
                   position = position_jitterdodge(dodge.width = .3, jitter.width = 0.1, jitter.height = 0),
                  size = 2) +
        #geom_errorbar(data = copolarMean, aes(x = xlabel, ymin = meanCopolar-sdCopolar, ymax = meanCopolar+sdCopolar),
                      # position = position_dodge(width = .5), 
                      # width = 0.25,
                      # alpha = 0.5) +
        theme_classic() + 
        ylab("Co-polarized Cells (%)") +
        xlab("siRNA") +
        ggtitle(titleName) +
          scale_fill_manual(values = clr) +
        #labs(shape = "Replicate") +
        theme(axis.title = element_text(size = 14),
              axis.text.y = element_text(size = 14),
              axis.text.x = element_text(size = 12),
              title = element_text(size = 14),
              legend.position = "none")+
        ylim(0,105))
    }else{
      print(ggplot() +
      geom_col(data = copolarMean, aes(x = xlabel, y = meanCopolar, fill = xlabel),  position = position_dodge(), width = 0.6, color = "black") +
      geom_point(data = copolarData %>% filter(copolarFactin == 1), aes(x = xlabel, y = perc, fill = experimentGroup),
                 position = position_jitterdodge(dodge.width = .3, jitter.width = 0.1, jitter.height = 0),
                size = 2) +
      geom_errorbar(data = copolarMean, aes(x = xlabel, ymin = meanCopolar-sdCopolar, ymax = meanCopolar+sdCopolar),
                    position = position_dodge(width = .6),
                    width = 0.4,
                    alpha = 0.6) +
      theme_classic() + 
      ylab("Co-polarized Cells (%)") +
      xlab("siRNA") +
      ggtitle(titleName) +
      #labs(shape = "Replicate") +
        scale_fill_manual(values = clr) +
      theme(axis.title = element_text(size = 14),
            axis.text.y = element_text(size = 14),
            axis.text.x = element_text(size = 12),
            title = element_text(size = 14),
            legend.position = "none")+
        ylim(0,105))
    }
    return(copolarData)
}

kEzr <- plotCopolar(copolarizationLabeled, "StainMCAM-EZR", c("Control", "EZR"), c("20211205KD", "20220509KD", "20210406KD"), "MCAM + EZR")
# ggsave(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/copolarEZR_No0406Cov2.svg", sep = ""), width = 1.8, height = 3, units = "in", dpi = 600)
# write_csv(kEzr, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/copolarEZR_No0406Cov2_Perc.csv", sep = ""))
wilcox.test(perc ~ xlabel, kEzr %>% filter(copolarOther == T) %>% dplyr::mutate(xlabel = factor(xlabel, levels = c("EZR", "Control"))), alternative = "less")
t.test(perc ~ xlabel, kEzr %>% filter(copolarOther == T) %>% dplyr::mutate(xlabel = factor(xlabel, levels = c("EZR", "Control"))), alternative = "less")

kMsn <- plotCopolar(copolarizationLabeled, "StainMCAM-MSN", c("Control", "MSN"), c("20211205KD", "20220509KD", "20210406KD"), "MCAM + MSN")
# ggsave(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/copolarMSN_No0406Cov2.svg", sep = ""), width = 1.8, height = 3, units = "in", dpi = 600)
wilcox.test(perc ~ xlabel, kMsn %>% filter(copolarOther == T) %>% dplyr::mutate(xlabel = factor(xlabel, levels = c("MSN", "Control"))), alternative = "less")
# write_csv(kMsn, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/copolarMSN_No0406Cov2_Perc.csv", sep = ""))

kMyo <- plotCopolar(copolarizationLabeled, "StainMCAM-Myosin", c("Control", "EZR", "MSN", "RDX"), c("20210406KD", "20211205KD", "20220509KD", "20220530KD"), "MCAM + Myosin")
# ggsave(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/copolarMyosin_No0406Cov2.svg", sep = ""), width = 2.7, height = 3, units = "in", dpi = 600)
kruskal.test(perc ~ xlabel, kMyo %>% filter(copolarOther == T, xlabel != "RDX")) 
# write_csv(kMyo, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/copolarMyosin_No0406Cov2_Perc.csv", sep = ""))

kFactin <- plotCopolarThird(copolarizationLabeled, "Factin", c("Control", "EZR", "MSN", "RDX"), c("20211205KD", "20220509KD", "20220530KD"), "MCAM + Factin")
# ggsave(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/copolarFactin_No0406Cov2.svg", sep = ""), width = 2.7, height = 3, units = "in", dpi = 600)
# write_csv(kFactin, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/copolarFactinAF405__No0406Cov2Perc.csv", sep = ""))
kruskal.test(perc ~ xlabel, kFactin %>% filter(copolarFactin == T))

copolarizationLabeled %>% group_by(experimentGroup, Experiment, mainCondition, Condition, mainRep) %>% count(Replicate) %>% ungroup()
copolarizationLabeled %>% group_by(experimentGroup, Experiment, mainCondition, Condition, mainRep) %>% count(Coverslip) %>% ungroup()

copolarizationLabeled %>%
  dplyr::mutate(Condition2 = str_remove(Condition, "-Factin")) %>%
  group_by(xlabel, experimentGroup, Condition) %>%
  count(Condition2) %>%
  ungroup() %>%
  arrange(Condition2)

testCopolarPerc <- copolarizationLabeled %>%
  dplyr::mutate(Condition2 = str_remove(Condition, "-Factin")) %>%
  group_by(xlabel, experimentGroup, Condition2) %>%
  count(copolarOther) %>%
  dplyr::mutate(perc = n/(sum(n))*100, nTot = sum(n)) %>%
  ungroup()
# write_csv(testCopolarPerc, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/PaperFigures/test_CopolarOther.csv", sep = ""))

testCopolarFactin <- copolarizationLabeled %>%
  filter(!Experiment %in% twoChannelExperiments) %>%
  group_by(xlabel, experimentGroup) %>%
  count(copolarFactin) %>%
  dplyr::mutate(perc = n/(sum(n))*100, nTot = sum(n)) %>%
  ungroup()
identical(kFactin$perc, testCopolarFactin$perc)

copolarizationLabeled %>% group_by(experimentGroup) %>% count(Condition)
nrow(copolarizationLabeled %>% filter(str_detect(Condition, "siRDX_StainMCAM-Myosin"), experimentGroup == "20220509KD"))
nrow(copolarizationLabeled %>% filter(str_detect(Image, "siRDX_MCAM488-120ms_Myo594"), experimentGroup == "20220509KD"))
nrow(copolarizationLabeled %>% filter(str_detect(Image, "siRDX_MCAM488-120ms_MSN594"), experimentGroup == "20220509KD"))
```

