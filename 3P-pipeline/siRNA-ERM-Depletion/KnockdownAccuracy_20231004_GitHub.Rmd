---
title: "Sensitivity, Specificity, and Feature Importance for ML Classification of siRNA Depletion Data"
output: html_notebook
---
This code compiles cleaned and scaled feature data for the siRNA depletion experiments, and applies the ML classifier generated in the siRNA_MachineLearning.Rmd notebook.

It was used to select a sample of cells to validate the ML accuracy, excluding those used as part of the iterative classifier training. It calculates the sensitivity, specificity, and precision of each iteration of training (Fig. 5D, Supp. Fig. 8A). It also calculates the sensitivity, specificity, and precision for each condition and replicate (Supplemental Table S9). 

It also examines feature importance and generates violin plots for the most important features. It generates the violin plot of feature values based on manual scoring (Fig. 5B).

Supplemental data for Supp. Table S13 in the last chunks.

Finally, it calculates the percentage of cells with "BothEnds" manual label and the percentage of "OneEnd" cells where the brightest object correctly corresponded to the polarized region.


```{r}
dirPath <- "/Volumes/ahngrp/Suzannah_Thesis_Paper/ERM_Knockdown/" # dirPath <- "Z:/Suzannah_Thesis_Paper/ERM_Knockdown/"
```

Load packages:
```{r}
options(java.parameters = "-Xmx8g")
library(readxl)
library(tidyverse)
library(caret)
library(gridExtra)
# options(rgl.useNULL=TRUE)
# library(rgl)
# library(Rdimtools)
library(gbm)
library(extraTrees)
library(ggbeeswarm)

```
Functions
```{r}
# This function accepts Matlab output for 2- or 3-channel experiments, and combines them into one data.frame, appending the variable names of the channel specific measurements with the channel name provided in the input (e.g., the name of the stained protein). For a 3-channel experiment Matlab exports 4 files. The _Cell file contains colocalization metrics and measurements shared by all channels (i.e., Area, Max Feret Diameter, etc.). The other files (_chName) contain channel specific measurements. Provide the full path for the matlab files in the function input.
importMatlabMulti <- function(matlabCell, matlabChannel1, matlabChannel2, matlabChannel3, annotationdf, ch1Name, ch2Name, ch3Name){
  cellMeasRaw <- read.csv(matlabCell)
  cellMeas <- cellMeasRaw %>%
    filter(!cell == "")
  cellMeas <- unique(cellMeas)
  
  ch1 <- unique(cbind(cellMeasRaw %>% dplyr::select(Area, cell), read.csv(matlabChannel1))) %>%
    filter(!is.na(intensityWrampHalves)) %>%
    dplyr::rename(meanIntensityNotWramp = meanNotWramp,
           medianIntensityNotWramp = medianNotWramp,
           sumIntensityNotWramp = sumNotWramp,
           meanIntensityNotBright = meanNotBright,
           sumIntensityNotBright = sumNotBright,
           medianIntensityNotBright = medianNotBright) %>%
    dplyr::mutate(meanWrampOverNot = meanIntensityWramp/meanIntensityNotWramp,
           meanWrampOverNotBright = meanIntensityWramp/meanIntensityNotBright,
           meanSecondOverNotBright = meanIntensitySecond/meanIntensityNotBright,
           sumWrampOverNot = sumIntensityWramp/sumIntensityNotWramp,
           sumWrampOverNotBright = sumIntensityWramp/sumIntensityNotBright,
           sumSecondOverNotBright = sumIntensitySecond/sumIntensityNotBright,
           medianWrampOverNot = medianIntensityWramp/medianIntensityNotWramp,
           medianWrampOverNotBright = medianIntensityWramp/medianIntensityNotBright,
           medianSecondOverNotBright = medianIntensitySecond/medianIntensityNotBright,
           sumOverMedianIntensityWramp = sumIntensityWramp/medianIntensityWramp,
           relAreaWrampCell = areaWramp/Area,
           relAreaWrampBright = areaWramp/areaBrightObj,
           massDisplacement = ifelse(massDisplacement < 1, 1, massDisplacement)) %>%
    dplyr::select(-Area) %>%
    rename_with(~str_c(.,paste("_", ch1Name, sep = "")), .cols = -contains("cell", ignore.case = F))
  ch2 <- unique(cbind(read.csv(matlabChannel2), cellMeasRaw %>% dplyr::select(Area, cell))) %>%
    filter(cell %in% ch1$cell) %>%
    dplyr::rename(meanIntensityNotWramp = meanNotWramp,
           medianIntensityNotWramp = medianNotWramp,
           sumIntensityNotWramp = sumNotWramp,
           meanIntensityNotBright = meanNotBright,
           sumIntensityNotBright = sumNotBright,
           medianIntensityNotBright = medianNotBright) %>%
    dplyr::mutate(meanWrampOverNot = meanIntensityWramp/meanIntensityNotWramp,
           meanWrampOverNotBright = meanIntensityWramp/meanIntensityNotBright,
           meanSecondOverNotBright = meanIntensitySecond/meanIntensityNotBright,
           sumWrampOverNot = sumIntensityWramp/sumIntensityNotWramp,
           sumWrampOverNotBright = sumIntensityWramp/sumIntensityNotBright,
           sumSecondOverNotBright = sumIntensitySecond/sumIntensityNotBright,
           medianWrampOverNot = medianIntensityWramp/medianIntensityNotWramp,
           medianWrampOverNotBright = medianIntensityWramp/medianIntensityNotBright,
           medianSecondOverNotBright = medianIntensitySecond/medianIntensityNotBright,
           sumOverMedianIntensityWramp = sumIntensityWramp/medianIntensityWramp,
           relAreaWrampCell = areaWramp/Area,
           relAreaWrampBright = areaWramp/areaBrightObj,
           massDisplacement = ifelse(massDisplacement < 1, 1, massDisplacement)) %>%
        dplyr::select(-Area) %>%
    rename_with(~str_c(.,paste("_", ch2Name, sep = "")), .cols = -contains("cell", ignore.case = F))
  if(matlabChannel3 != "empty"){
    ch3 <- unique(cbind(cellMeasRaw %>% dplyr::select(Area, cell), read.csv(matlabChannel3))) %>%
      filter(cell %in% ch1$cell) %>%
      dplyr::rename(meanIntensityNotWramp = meanNotWramp,
             medianIntensityNotWramp = medianNotWramp,
             sumIntensityNotWramp = sumNotWramp,
             meanIntensityNotBright = meanNotBright,
             sumIntensityNotBright = sumNotBright,
             medianIntensityNotBright = medianNotBright) %>%
      dplyr::mutate(meanWrampOverNot = meanIntensityWramp/meanIntensityNotWramp,
             meanWrampOverNotBright = meanIntensityWramp/meanIntensityNotBright,
             meanSecondOverNotBright = meanIntensitySecond/meanIntensityNotBright,
             sumWrampOverNot = sumIntensityWramp/sumIntensityNotWramp,
             sumWrampOverNotBright = sumIntensityWramp/sumIntensityNotBright,
             sumSecondOverNotBright = sumIntensitySecond/sumIntensityNotBright,
             medianWrampOverNot = medianIntensityWramp/medianIntensityNotWramp,
             medianWrampOverNotBright = medianIntensityWramp/medianIntensityNotBright,
             medianSecondOverNotBright = medianIntensitySecond/medianIntensityNotBright,
             sumOverMedianIntensityWramp = sumIntensityWramp/medianIntensityWramp,
             relAreaWrampCell = areaWramp/Area,
             relAreaWrampBright = areaWramp/areaBrightObj,
             massDisplacement = ifelse(massDisplacement < 1, 1, massDisplacement)) %>%
      dplyr::select(-Area) %>%
      rename_with(~str_c(.,paste("_", ch3Name, sep = "")), .cols = -contains("cell", ignore.case = F))
  }
  
  if(matlabChannel3 != "empty"){
    matlab <- merge(cellMeas, merge(ch1, merge(ch2, ch3, by = "cell"), by = "cell"), by = "cell")
  }else{
    matlab <- merge(cellMeas, merge(ch1, ch2, by = "cell"), by = "cell")
  }
  matlab <- matlab %>%
    separate(cell, into = c("Image", "ObjectNumber"), sep = "Cell_", convert = TRUE) %>%
    dplyr::select(-Image) %>%
    dplyr::rename(Image = image) %>%
    #filter(!is.na(ObjectNumber)) %>%
    unite(Object, c("Image","ObjectNumber"), remove = FALSE) %>%
    dplyr::select(-ObjectNumber) %>%
    arrange(Object)
    
  
  matlabAnnotated <- merge(annotationdf, matlab, by = "Image")
}

# This function reads cell-level results from CellProfiler and adds annotation from the image file
readCp <- function(cpImgPath, cpCellPath){
  cpImg <-read.csv(cpImgPath)
  
  if(any(str_detect(colnames(cpImg), "Image_FileName_ImgMcam"))){
    cpCell <- merge(read.csv(cpCellPath), dplyr::select(cpImg, ImageNumber, Image_FileName_ImgMcam), by = "ImageNumber") %>%
      unite(Object, c(Image_FileName_ImgMcam, ObjectNumber), remove = F) %>%
      arrange(Object)
  }else{
    cpCell <- merge(read.csv(cpCellPath), dplyr::select(cpImg, ImageNumber, Image_FileName_ImgMain), by = "ImageNumber") %>%
      unite(Object, c(Image_FileName_ImgMain, ObjectNumber), remove = F) %>%
      arrange(Object)
  }
}

# This function combines features measured in matlab and CellProfiler, removes redundant features, calculates CV for Intensity and IntensityEdge from CellProfiler measurements, converts Haralick features into rotation-invariant form (not angularly dependent) by taking the mean and range, and removes small round cells based on area and max Feret diameter. CellProfiler subscript (cpSubscript) and matlab channel names (chName) indicating the different channels need to match the subscripts in the input dataframes.
combineMetrics <- function(matlab, cpCell, cpSubscript1, cpSubscript2, cpSubscript3, chName1, chName2, chName3){
  metrics <- merge(matlab, cpCell, by = "Object") %>%
    dplyr::select(-AreaShape_Orientation, 
           -contains("Intensity_MedianIntensity_BgSubtracted"), 
           -contains("Intensity_IntegratedIntensity"),
           -contains("Intensity_MassDisplacement"),
           -Number_Object_Number,
           -AreaShape_MajorAxisLength, 
           -AreaShape_MinorAxisLength, 
           -AreaShape_MaxFeretDiameter,
           -AreaShape_MinFeretDiameter,
           -AreaShape_Eccentricity,
           -AreaShape_Area) %>% # Remove identical metrics from matlab and CellProfiler
    dplyr::select(-OriginalId, -contains("Image_FileName_"),
           -contains("MaxFeretCoordinates"), -contains("MinFeretCoordinates"), 
           -contains("Orientation"), -contains("MaxFeretAngle"), -contains("MinFeretAngle"), 
           -contains("wrampAngle"), -contains("secondAngle"), -contains("majAngle"), 
           -contains("Center_X"), -contains("Center_Y"), -contains("Center_Z"), -contains("Location_"), 
           -contains("BoundingBoxM"), -contains("EulerNumber")) # Remove coordinate-based metrics and nonnumeric info. 
  
  texturize <- function(cpSubscript, chName){
    metricsTexture <- metrics %>% 
      dplyr::select(Object, contains("Texture"), contains("Intensity_StdIntensityEdge"), contains("Intensity_MeanIntensity"), contains("Intensity_StdIntensity")) %>%
      dplyr::select(Object, contains(cpSubscript)) %>%
      rename_with(~gsub(cpSubscript, '', .x), .cols = everything()) %>%
      rowwise() %>%
      dplyr::mutate(Texture_AngularSecondMoment_2_Mean = mean(c(Texture_AngularSecondMoment_2_00_256, Texture_AngularSecondMoment_2_01_256, Texture_AngularSecondMoment_2_02_256, Texture_AngularSecondMoment_2_03_256)),
           Texture_AngularSecondMoment_8_Mean = mean(c(Texture_AngularSecondMoment_8_00_256, Texture_AngularSecondMoment_8_01_256, Texture_AngularSecondMoment_8_02_256, Texture_AngularSecondMoment_8_03_256)),
           Texture_Contrast_2_Mean = mean(c(Texture_Contrast_2_00_256, Texture_Contrast_2_01_256, Texture_Contrast_2_02_256, Texture_Contrast_2_03_256)),
           Texture_Contrast_8_Mean = mean(c(Texture_Contrast_8_00_256, Texture_Contrast_8_01_256, Texture_Contrast_8_02_256, Texture_Contrast_8_03_256)),
           Texture_Correlation_2_Mean = mean(c(Texture_Correlation_2_00_256, Texture_Correlation_2_01_256, Texture_Correlation_2_02_256, Texture_Correlation_2_03_256)),
           Texture_Correlation_8_Mean = mean(c(Texture_Correlation_8_00_256, Texture_Correlation_8_01_256, Texture_Correlation_8_02_256, Texture_Correlation_8_03_256)),
           Texture_DifferenceEntropy_2_Mean = mean(c(Texture_DifferenceEntropy_2_00_256, Texture_DifferenceEntropy_2_01_256, Texture_DifferenceEntropy_2_02_256, Texture_DifferenceEntropy_2_03_256)),
           Texture_DifferenceEntropy_8_Mean = mean(c(Texture_DifferenceEntropy_8_00_256, Texture_DifferenceEntropy_8_01_256, Texture_DifferenceEntropy_8_02_256, Texture_DifferenceEntropy_8_03_256)),
           Texture_DifferenceVariance_2_Mean = mean(c(Texture_DifferenceVariance_2_00_256, Texture_DifferenceVariance_2_01_256, Texture_DifferenceVariance_2_02_256, Texture_DifferenceVariance_2_03_256)),
           Texture_DifferenceVariance_8_Mean = mean(c(Texture_DifferenceVariance_8_00_256, Texture_DifferenceVariance_8_01_256, Texture_DifferenceVariance_8_02_256, Texture_DifferenceVariance_8_03_256)),
           Texture_Entropy_2_Mean = mean(c(Texture_Entropy_2_00_256, Texture_Entropy_2_01_256, Texture_Entropy_2_02_256, Texture_Entropy_2_03_256)),
           Texture_Entropy_8_Mean = mean(c(Texture_Entropy_8_00_256, Texture_Entropy_8_01_256, Texture_Entropy_8_02_256, Texture_Entropy_8_03_256)),
           Texture_InfoMeas1_2_Mean = mean(c(Texture_InfoMeas1_2_00_256, Texture_InfoMeas1_2_01_256, Texture_InfoMeas1_2_02_256, Texture_InfoMeas1_2_03_256)),
           Texture_InfoMeas1_8_Mean = mean(c(Texture_InfoMeas1_8_00_256, Texture_InfoMeas1_8_01_256, Texture_InfoMeas1_8_02_256, Texture_InfoMeas1_8_03_256)),
           Texture_InfoMeas2_2_Mean = mean(c(Texture_InfoMeas2_2_00_256, Texture_InfoMeas2_2_01_256, Texture_InfoMeas2_2_02_256, Texture_InfoMeas2_2_03_256)),
           Texture_InfoMeas2_8_Mean = mean(c(Texture_InfoMeas2_8_00_256, Texture_InfoMeas2_8_01_256, Texture_InfoMeas2_8_02_256, Texture_InfoMeas2_8_03_256)),
           Texture_InverseDifferenceMoment_2_Mean = mean(c(Texture_InverseDifferenceMoment_2_00_256, Texture_InverseDifferenceMoment_2_01_256, Texture_InverseDifferenceMoment_2_02_256, Texture_InverseDifferenceMoment_2_03_256)),
           Texture_InverseDifferenceMoment_8_Mean = mean(c(Texture_InverseDifferenceMoment_8_00_256, Texture_InverseDifferenceMoment_8_01_256, Texture_InverseDifferenceMoment_8_02_256, Texture_InverseDifferenceMoment_8_03_256)),
           Texture_SumAverage_2_Mean = mean(c(Texture_SumAverage_2_00_256, Texture_SumAverage_2_01_256, Texture_SumAverage_2_02_256, Texture_SumAverage_2_03_256)),
           Texture_SumAverage_8_Mean = mean(c(Texture_SumAverage_8_00_256, Texture_SumAverage_8_01_256, Texture_SumAverage_8_02_256, Texture_SumAverage_8_03_256)),
           Texture_SumEntropy_2_Mean = mean(c(Texture_SumEntropy_2_00_256, Texture_SumEntropy_2_01_256, Texture_SumEntropy_2_02_256, Texture_SumEntropy_2_03_256)),
           Texture_SumEntropy_8_Mean = mean(c(Texture_SumEntropy_8_00_256, Texture_SumEntropy_8_01_256, Texture_SumEntropy_8_02_256, Texture_SumEntropy_8_03_256)),
           Texture_SumVariance_2_Mean = mean(c(Texture_SumVariance_2_00_256, Texture_SumVariance_2_01_256, Texture_SumVariance_2_02_256, Texture_SumVariance_2_03_256)),
           Texture_SumVariance_8_Mean = mean(c(Texture_SumVariance_8_00_256, Texture_SumVariance_8_01_256, Texture_SumVariance_8_02_256, Texture_SumVariance_8_03_256)),
           Texture_Variance_2_Mean = mean(c(Texture_Variance_2_00_256, Texture_Variance_2_01_256, Texture_Variance_2_02_256, Texture_Variance_2_03_256)),
           Texture_Variance_8_Mean = mean(c(Texture_Variance_8_00_256, Texture_Variance_8_01_256, Texture_Variance_8_02_256, Texture_Variance_8_03_256)),
           Texture_AngularSecondMoment_2_Range = diff(range(c(Texture_AngularSecondMoment_2_00_256, Texture_AngularSecondMoment_2_01_256, Texture_AngularSecondMoment_2_02_256, Texture_AngularSecondMoment_2_03_256))),
           Texture_AngularSecondMoment_8_Range = diff(range(c(Texture_AngularSecondMoment_8_00_256, Texture_AngularSecondMoment_8_01_256, Texture_AngularSecondMoment_8_02_256, Texture_AngularSecondMoment_8_03_256))),
           Texture_Contrast_2_Range = diff(range(c(Texture_Contrast_2_00_256, Texture_Contrast_2_01_256, Texture_Contrast_2_02_256, Texture_Contrast_2_03_256))),
           Texture_Contrast_8_Range = diff(range(c(Texture_Contrast_8_00_256, Texture_Contrast_8_01_256, Texture_Contrast_8_02_256, Texture_Contrast_8_03_256))),
           Texture_Correlation_2_Range = diff(range(c(Texture_Correlation_2_00_256, Texture_Correlation_2_01_256, Texture_Correlation_2_02_256, Texture_Correlation_2_03_256))),
           Texture_Correlation_8_Range = diff(range(c(Texture_Correlation_8_00_256, Texture_Correlation_8_01_256, Texture_Correlation_8_02_256, Texture_Correlation_8_03_256))),
           Texture_DifferenceEntropy_2_Range = diff(range(c(Texture_DifferenceEntropy_2_00_256, Texture_DifferenceEntropy_2_01_256, Texture_DifferenceEntropy_2_02_256, Texture_DifferenceEntropy_2_03_256))),
           Texture_DifferenceEntropy_8_Range = diff(range(c(Texture_DifferenceEntropy_8_00_256, Texture_DifferenceEntropy_8_01_256, Texture_DifferenceEntropy_8_02_256, Texture_DifferenceEntropy_8_03_256))),
           Texture_DifferenceVariance_2_Range = diff(range(c(Texture_DifferenceVariance_2_00_256, Texture_DifferenceVariance_2_01_256, Texture_DifferenceVariance_2_02_256, Texture_DifferenceVariance_2_03_256))),
           Texture_DifferenceVariance_8_Range = diff(range(c(Texture_DifferenceVariance_8_00_256, Texture_DifferenceVariance_8_01_256, Texture_DifferenceVariance_8_02_256, Texture_DifferenceVariance_8_03_256))),
           Texture_Entropy_2_Range = diff(range(c(Texture_Entropy_2_00_256, Texture_Entropy_2_01_256, Texture_Entropy_2_02_256, Texture_Entropy_2_03_256))),
           Texture_Entropy_8_Range = diff(range(c(Texture_Entropy_8_00_256, Texture_Entropy_8_01_256, Texture_Entropy_8_02_256, Texture_Entropy_8_03_256))),
           Texture_InfoMeas1_2_Range = diff(range(c(Texture_InfoMeas1_2_00_256, Texture_InfoMeas1_2_01_256, Texture_InfoMeas1_2_02_256, Texture_InfoMeas1_2_03_256))),
           Texture_InfoMeas1_8_Range = diff(range(c(Texture_InfoMeas1_8_00_256, Texture_InfoMeas1_8_01_256, Texture_InfoMeas1_8_02_256, Texture_InfoMeas1_8_03_256))),
           Texture_InfoMeas2_2_Range = diff(range(c(Texture_InfoMeas2_2_00_256, Texture_InfoMeas2_2_01_256, Texture_InfoMeas2_2_02_256, Texture_InfoMeas2_2_03_256))),
           Texture_InfoMeas2_8_Range = diff(range(c(Texture_InfoMeas2_8_00_256, Texture_InfoMeas2_8_01_256, Texture_InfoMeas2_8_02_256, Texture_InfoMeas2_8_03_256))),
           Texture_InverseDifferenceMoment_2_Range = diff(range(c(Texture_InverseDifferenceMoment_2_00_256, Texture_InverseDifferenceMoment_2_01_256, Texture_InverseDifferenceMoment_2_02_256, Texture_InverseDifferenceMoment_2_03_256))),
           Texture_InverseDifferenceMoment_8_Range = diff(range(c(Texture_InverseDifferenceMoment_8_00_256, Texture_InverseDifferenceMoment_8_01_256, Texture_InverseDifferenceMoment_8_02_256, Texture_InverseDifferenceMoment_8_03_256))),
           Texture_SumAverage_2_Range = diff(range(c(Texture_SumAverage_2_00_256, Texture_SumAverage_2_01_256, Texture_SumAverage_2_02_256, Texture_SumAverage_2_03_256))),
           Texture_SumAverage_8_Range = diff(range(c(Texture_SumAverage_8_00_256, Texture_SumAverage_8_01_256, Texture_SumAverage_8_02_256, Texture_SumAverage_8_03_256))),
           Texture_SumEntropy_2_Range = diff(range(c(Texture_SumEntropy_2_00_256, Texture_SumEntropy_2_01_256, Texture_SumEntropy_2_02_256, Texture_SumEntropy_2_03_256))),
           Texture_SumEntropy_8_Range = diff(range(c(Texture_SumEntropy_8_00_256, Texture_SumEntropy_8_01_256, Texture_SumEntropy_8_02_256, Texture_SumEntropy_8_03_256))),
           Texture_SumVariance_2_Range = diff(range(c(Texture_SumVariance_2_00_256, Texture_SumVariance_2_01_256, Texture_SumVariance_2_02_256, Texture_SumVariance_2_03_256))),
           Texture_SumVariance_8_Range = diff(range(c(Texture_SumVariance_8_00_256, Texture_SumVariance_8_01_256, Texture_SumVariance_8_02_256, Texture_SumVariance_8_03_256))),
           Texture_Variance_2_Range = diff(range(c(Texture_Variance_2_00_256, Texture_Variance_2_01_256, Texture_Variance_2_02_256, Texture_Variance_2_03_256))),
           Texture_Variance_8_Range = diff(range(c(Texture_Variance_8_00_256, Texture_Variance_8_01_256, Texture_Variance_8_02_256, Texture_Variance_8_03_256)))) 
    metricsTexture <- metricsTexture %>%
      ungroup() %>%
      dplyr::mutate(CV_IntensityEdge = Intensity_StdIntensityEdge/Intensity_MeanIntensityEdge,
           CV_IntensityCell = Intensity_StdIntensity/Intensity_MeanIntensity) %>%
      dplyr::select(-Intensity_MeanIntensity, -Intensity_StdIntensity, -Intensity_StdIntensityEdge, -Intensity_MeanIntensityEdge) %>%
      rename_with(~str_c(., paste("_", chName, sep = "")), .cols = everything()) %>%
      dplyr::select(-contains("_256"))
  }
  metricsTexture1 <- texturize(cpSubscript1, chName1)
  metricsTexture2 <- texturize(cpSubscript2, chName2)
  if(chName3 != "empty"){metricsTexture3 <- texturize(cpSubscript3, chName3)}
  
  metrics2 <- merge(metrics %>% dplyr::select(-contains("Texture")), metricsTexture1, by.x = "Object", by.y = paste("Object_", chName1, sep = ""))
  metrics3 <- merge(metrics2, metricsTexture2, by.x = "Object", by.y = paste("Object_", chName2, sep = ""))
  if(chName3 != "empty"){
    metrics4 <- merge(metrics3, metricsTexture3, by.x = "Object", by.y = paste("Object_", chName3, sep = ""))
    metricsAll <- metrics4
  }else{
    metricsAll <- metrics3
  }
  
  metricsAll <- metricsAll %>%
      dplyr::select(-contains("Intensity_MeanIntensity_"))
  
  tooSmall <- c(metricsAll %>% filter(Area < 17000 | MaxFeretDiameter < 350) %>% dplyr::select(Object), metrics2 %>% filter(MaxFeretDiameter < 400, Area < 34000) %>% dplyr::select(Object))
  metricsClean <- metricsAll %>%
   filter(!Object %in% tooSmall[[1]], !Object %in% tooSmall[[2]])
}

# Function to rename normAreaFeatures to be specific to a certain channel's variable names:
normAreaFeaturesChannel <- function(normAreaFeatures, chName){
  chInvariantFeatures <- c("Area", "MajorAxisLength", "MinorAxisLength",  "Eccentricity", "MaxFeretDiameter", "MinFeretDiameter", "AreaShape_BoundingBoxArea", "AreaShape_ConvexArea", "AreaShape_EquivalentDiameter", "AreaShape_MaximumRadius", "AreaShape_MeanRadius", "AreaShape_MedianRadius", "AreaShape_Perimeter")

  normAreaChFeatures <- setdiff(normAreaFeatures, chInvariantFeatures) %>%
    str_c(., paste("_", chName, sep = ""))
  features <- c(chInvariantFeatures, normAreaChFeatures)
}

# Function to calculate the median of each area feature across the control condition of cells in the training experiment
controlMedianAreas <- function(metricsClean, normAreaFeatures, manual){
  medianAreas <- metricsClean %>%
    filter(Object %in% manual$Object) %>% # Remove incorrectly segmented (not a single cell) objects
    dplyr::select(all_of(normAreaFeatures), "Normalization") %>%
    filter(Normalization == "Control") %>%
    group_by(Normalization) %>%
    summarize_all(median, na.rm = T) %>%
    ungroup() %>%
    dplyr::select(-Normalization)
} 

# This function scales area-based features by dividing by the median value of cells in the training experiment (control-condition only). It also normalizes intensity values (to account for variability between conditions and experiments collected on different days) by providing values in relative terms (dividing measurements by the mean or integrated intensity of the cell). It is intended for use on V1 features. Features that are already expressed as a proportion or a [0 1] scale are not changed (e.g., profile measurement, relative area, wrampHalves, brightPix, etc.).
scaleAreaIntensity <- function(metrics, normAreaFeatures, controlMedian, colocFeatures, chName, cpSubscript){
  areaMetrics <- dplyr::select(metrics, all_of(normAreaFeatures))
  scaleArea <- as.data.frame(mapply('/', areaMetrics, controlMedian)) #%>%
    #dplyr::mutate_all(log)
  
  annotFeatures <- c("Object", "Image", "Experiment", "Replicate", "Coverslip", "Condition", "mainCondition", "mainReplicate", "experimentGroup", "Normalization")
  normNonArea <- metrics %>%
    dplyr::select(-all_of(colocFeatures)) %>%
    dplyr::select(-all_of(normAreaFeatures)) %>%
    dplyr::select(any_of(annotFeatures), contains(paste("_", chName, sep = "")), contains(cpSubscript)) %>%
    rename_with(~gsub(cpSubscript, '', .x), .cols = contains(cpSubscript)) %>%
    rename_with(~gsub(paste("_", chName, sep = ""), '', .x), .cols = contains(paste("_", chName, sep = ""))) %>%
    dplyr::select(-largeObj, -brightMeanObj, -brightSumObj) %>%
    dplyr::mutate(angleWramp2Major = angleWramp2Major/90,
           angleSecond2Major = angleSecond2Major/90,
           angleWramp2Second = angleWramp2Second/180,
           intensityWrampHalves = log(intensityWrampHalves),
           intensityMajorHalves = log(intensityMajorHalves),
           intensitySecondHalves = log(intensitySecondHalves),
           medianObjectMeanIntensity = medianObjectMeanIntensity/meanIntensityCell, # Fixed
           medianObjectSumIntensity = medianObjectSumIntensity/sumIntensityCell,   # Fixed
           meanIntensityWramp = meanIntensityWramp/meanIntensityCell,
           medianIntensityWramp = medianIntensityWramp/medianIntensityCell,
           meanIntensityBrightObj = meanIntensityBrightObj/meanIntensityCell,
           sumIntensityBrightObj = sumIntensityBrightObj/sumIntensityCell,
           sumIntensityWramp = sumIntensityWramp/sumIntensityCell,
           sumIntensityNotWramp = sumIntensityNotWramp/sumIntensityCell, 
           sumIntensityNotBright = sumIntensityNotBright/sumIntensityCell, 
           sumIntensitySecond = sumIntensitySecond/sumIntensityCell,
           meanIntensityNotWramp = meanIntensityNotWramp/meanIntensityCell,
           medianIntensityNotWramp = medianIntensityNotWramp/medianIntensityCell,
           meanIntensityNotBright = meanIntensityNotBright/meanIntensityCell,
           medianIntensityNotBright = medianIntensityNotBright/medianIntensityCell,
           meanIntensitySecond = meanIntensitySecond/meanIntensityCell,
           medianIntensitySecond = medianIntensitySecond/medianIntensityCell) %>%
    dplyr::mutate(Intensity_LowerQuartileIntensity = Intensity_LowerQuartileIntensity/meanIntensityCell, 
                  Intensity_MADIntensity = Intensity_MADIntensity/meanIntensityCell,
                  Intensity_MaxIntensityEdge = Intensity_MaxIntensityEdge/meanIntensityCell,
                  Intensity_MaxIntensity = Intensity_MaxIntensity/meanIntensityCell,
                  Intensity_MeanIntensityEdge = Intensity_MeanIntensityEdge/meanIntensityCell,
                  Intensity_MinIntensityEdge = Intensity_MinIntensityEdge/meanIntensityCell,
                  Intensity_MinIntensity = Intensity_MinIntensity/meanIntensityCell,
                  Intensity_UpperQuartileIntensity = Intensity_UpperQuartileIntensity/meanIntensityCell) %>%
    dplyr::select(-meanIntensityCell, -medianIntensityCell, -sumIntensityCell, -Intensity_StdIntensityEdge, -Intensity_StdIntensity, 
           -contains("MeanFrac_")) %>%
    rename_with(~str_c(., paste("_", chName, sep = "")), .cols = -contains(annotFeatures))
  
  normMetrics <- cbind(normNonArea, scaleArea)
}

# Confusion matrix of ML classification (prediction) vs. manual scoring (reference)
# Supply fit from caret to function
analyzeResults <- function(dataset, fit, score, conditionName){
  dataset <- dplyr::select(dataset, -Normalization) %>%
    rename(refScore = score,
           useCondition = conditionName)
  Prediction <- predict(fit, dataset)
  Reference <- dataset$refScore
  ConditionGroup <- dataset$useCondition
  Confidence <- dplyr::select(dataset, contains("Confidence"))
  confusData <- data.frame(as.character(Prediction), as.character(Reference), ConditionGroup, Confidence) %>%
    dplyr::mutate(Prediction = factor(Prediction, levels = c("OneEnd", "BothEnds", "None")),
           Reference = factor(Reference, levels = c("OneEnd", "BothEnds", "None")))

  conditions <- unique(confusData$ConditionGroup)
  for(val in 1:length(conditions)){
    print(conditions[val])
    print(caret::confusionMatrix(confusData$Prediction[confusData$ConditionGroup == conditions[val]],
                      confusData$Reference[confusData$ConditionGroup == conditions[val]]))
    print("High Confidence")
    print(caret::confusionMatrix(confusData$Prediction[confusData$ConditionGroup == conditions[val] & confusData$Confidence !=2],
                      confusData$Reference[confusData$ConditionGroup == conditions[val] & confusData$Confidence != 2]))
  }
  
  ggplot(confusData, aes(x = ConditionGroup)) + geom_bar(aes(fill = Prediction), position = position_fill(reverse = T))
}

# Alternate function for generating confusion matrix. Add ML classification as a variable to the dataset before inputting to function. Provide names of both variables to compare (e.g., ML classification and manual score)
analyzeResults2 <- function(dataset, className, score, conditionName){
  dataset <- dplyr::select(dataset, -Normalization) %>%
    dplyr::rename(Prediction = className,
                  refScore = score,
                  useCondition = conditionName)
  Prediction <- dataset$Prediction
  Reference <- dataset$refScore
  ConditionGroup <- dataset$useCondition
  Confidence <- dplyr::select(dataset, contains("Confidence"))
  
  confusData <- data.frame(as.character(Prediction), as.character(Reference), ConditionGroup, Confidence) %>%
    dplyr::mutate(Prediction = factor(Prediction, levels = c("OneEnd", "BothEnds", "None")),
           Reference = factor(Reference, levels = c("OneEnd", "BothEnds", "None")))
  
  conditions <- unique(confusData$ConditionGroup)
  for(val in 1:length(conditions)){
    print(conditions[val])
    print(caret::confusionMatrix(confusData$Prediction[confusData$ConditionGroup == conditions[val]],
                      confusData$Reference[confusData$ConditionGroup == conditions[val]]))
    print("High Confidence")
    print(caret::confusionMatrix(confusData$Prediction[confusData$ConditionGroup == conditions[val] & confusData$Confidence !=2],
                      confusData$Reference[confusData$ConditionGroup == conditions[val] & confusData$Confidence != 2]))
  }
  
  ggplot(confusData, aes(x = ConditionGroup)) + geom_bar(aes(fill = Prediction), position = position_fill(reverse = T))
}

# Wrapper function to fit two models and generate a combined classification where both classifiers must agree on one-ended WRAMP structures (reduces false positives at the cost of sensitivity). Classes are added to the metricsClean dataframe.
classifyCleanMetricsCombinedModels <- function(metricsCleaned, metricsScaled, fit1, fit2, columnName){
  metricsCleaned <- arrange(metricsCleaned, Object)
  metricsScaled <- arrange(metricsScaled, Object)
  metricsCleaned$prediction1 <- predict(fit1, metricsScaled)
  metricsCleaned$prediction2 <- predict(fit2, metricsScaled)
  metricsCleaned <- metricsCleaned %>%
    dplyr::mutate(prediction1 = as.character(prediction1), prediction2 = as.character(prediction2)) %>%
    dplyr::mutate(combo = ifelse((prediction1 == "OneEnd" & prediction2 != "OneEnd"), "None", prediction1)) %>%
    dplyr::mutate_at(c("prediction1", "prediction2", "combo"), function(x){factor(x, levels = c("OneEnd", "BothEnds", "None"))}) %>%
    dplyr::select(-prediction1, -prediction2) %>%
    dplyr::rename_with(~ gsub("combo", columnName, .x), .cols = "combo")
}

# Wrapper function to fit two models and generate a combined classification where both classifiers must agree on one-ended WRAMP structures (reduces false positives at the cost of sensitivity). Classes are added to the metricsClean dataframe.
classifyCleanMetricsCombinedModels <- function(metricsCleaned, metricsScaled, fit1, fit2, columnName){
  metricsCleaned <- arrange(metricsCleaned, Object)
  metricsScaled <- arrange(metricsScaled, Object)
  metricsCleaned$prediction1 <- predict(fit1, metricsScaled)
  metricsCleaned$prediction2 <- predict(fit2, metricsScaled)
  metricsCleaned <- metricsCleaned %>%
    dplyr::mutate(prediction1 = as.character(prediction1), prediction2 = as.character(prediction2)) %>%
    dplyr::mutate(combo = ifelse((prediction1 == "OneEnd" & prediction2 != "OneEnd"), "None", prediction1)) %>%
    dplyr::mutate_at(c("prediction1", "prediction2", "combo"), function(x){factor(x, levels = c("OneEnd", "BothEnds", "None"))}) %>%
    dplyr::select(-prediction1, -prediction2) %>%
    dplyr::rename_with(~ gsub("combo", columnName, .x), .cols = "combo")
}

# Wrapper to apply a single classifer to the data
classifyCleanMetricsOneModel <- function(metricsCleaned, metricsScaled, fit1, fit2, columnName){
  metricsCleaned <- arrange(metricsCleaned, Object)
  metricsScaled <- arrange(metricsScaled, Object)
  metricsCleaned$prediction1 <- predict(fit1, metricsScaled)
  metricsCleaned <- metricsCleaned %>%
  dplyr::rename_with(~ gsub("prediction1", columnName, .x), .cols = "prediction1")
}
```

Annotation files
```{r}
# Corrected:
experimentGroup <- data.frame(experimentGroup = c("20210210KD", "20210406KD", "20210513KD", "202107KD", "202107KD", "202107KD", "202107KD", "20211205KD", "20211205KD", "20211205KD", "20211205KD", "20211205KD", "20220509KD", "20220530KD"),
                              Experiment = c("20210210_EzrinKD", "20210406_KD", "20210513_MoesinKD", "20210723_KD1", "20210726_KD1", "20210728_KD2", "20210805_KD3", "20211205_KD_EZR_RepN", "20211205_KD_MSN_RepN", "20211205_KD_RDX_StainRDX_RepN", "20211205_KD_RDX_StainMyoIIB_RepN", "20211205_KD_RhoA_RepN", "20220509KD", "20220530_KD_RDX"))

# Original:
# experimentGroup <- data.frame(experimentGroup = c("20210210KD", "20210406KD", "20210513KD", "202107KD", "202107KD", "202107KD", "202107KD", "20211205KD", "20211205KD", "20211205KD", "20211205KD", "20220509KD", "20220530KD"),
#                               Experiment = c("20210210_EzrinKD", "20210406_KD", "20210513_MoesinKD", "20210723_KD1", "20210726_KD1", "20210728_KD2", "20210805_KD3", "20211205_KD_EZR_RepN", "20211205_KD_MSN_RepN", "20211205_KD_RDX_StainMyoIIB_RepN", "20211205_KD_RhoA_RepN", "20220509KD", "20220530_KD_RDX"))

annotation0513 <- read.csv(paste(dirPath, "20210513Transfection/Annotation20210513KD.csv", sep = "")) %>%
  dplyr::mutate(mainCondition = str_remove(Condition, "_Stain.*")) %>%
  dplyr::mutate(mainCondition = str_remove(mainCondition, ".*_")) %>%
  dplyr::mutate(mainRep = str_remove(Replicate, "_Stain.*")) %>%
  merge(experimentGroup, by = "Experiment")

annotationOld <- read.csv(paste(dirPath, "OlderExperiments/OlderKnockdowns_Annotation.csv", sep = "")) %>%
  dplyr::mutate(mainCondition = str_remove(Condition, "_Stain.*")) %>%
  dplyr::mutate(mainCondition = str_remove(mainCondition, ".*_")) %>%
  dplyr::mutate(mainRep = str_remove(Replicate, "_Stain.*")) %>%
  merge(experimentGroup, by = "Experiment")

annotation1205 <- read.csv(paste(dirPath, "20211205Transfection/20211205KD_Annotation.csv", sep = "")) %>%
  dplyr::mutate(mainCondition = str_remove(Condition, "_Stain.*")) %>%
  dplyr::mutate(mainCondition = str_remove(mainCondition, ".*_")) %>%
  dplyr::mutate(mainRep = str_remove(Replicate, "_Stain.*")) %>%
  merge(experimentGroup, by = "Experiment") %>%
  dplyr::mutate(Condition = str_remove(Condition, "20220509_")) %>% # Fix problem with annotation file
  dplyr::mutate(Condition = str_remove(Condition, "_KD.*")) %>%
  dplyr::mutate(Exclude = ifelse(Exclude == "Omit", "", Exclude))

annotation0509 <- read.csv(paste(dirPath, "20220509Transfection/20220509KD_Annotation.csv", sep = "")) %>%
  dplyr::mutate(mainCondition = str_remove(Condition, "_Stain.*")) %>%
  dplyr::mutate(mainCondition = str_remove(mainCondition, ".*_")) %>%
  dplyr::mutate(mainRep = str_remove(Replicate, "_Stain.*")) %>%
  merge(experimentGroup, by = "Experiment") %>%
  dplyr::mutate(Condition = str_remove(Condition, "20220509_")) %>% # Fix problem with annotation file
  dplyr::mutate(Condition = str_remove(Condition, "_KD.*"))

annotation0530 <- read_csv(paste(dirPath, "20220530Transfection/Annotation_20220530KD.csv", sep = "")) %>%
  dplyr::mutate(mainCondition = str_remove(Condition, "_Stain.*")) %>%
  dplyr::mutate(mainCondition = str_remove(mainCondition, ".*_")) %>%
  dplyr::mutate(mainRep = str_remove(Replicate, "_Stain.*")) %>%
  merge(experimentGroup, by = "Experiment")

annotation <- rbind(annotation0513 %>% select(all_of(colnames(annotation1205))),
                    annotationOld %>% select(all_of(colnames(annotation1205))),
                    annotation1205, 
                    annotation0509 %>% select(all_of(colnames(annotation1205))),
                    annotation0530 %>% select(all_of(colnames(annotation1205))))

  

excludeImages <- c("KD_EZR_MCAM_Myosin_Cov2_001.nd2", "KD_RhoA_Actin_Myosin_cov1_002.nd2", "KD_RDX_Myosin_cov1_003.nd2", "Cntr_EZR_MCAM_Actin_Cov2_007.nd2", "Cntr_RhoA_Actin_ROCK1_2_cov1_006")

#write.csv(annotation, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/allAnnotation20221101.csv", sep = ""), row.names = F)

## Check combined annotation file for errors
unique(select(annotation, experimentGroup, Experiment, mainRep))
unique(select(annotation, mainRep, Condition, Replicate))
unique(annotation$Condition)
```

Cell Profiler files:
```{r}
# Two-channel images
cp0513 <- readCp(paste(dirPath, "20210513Transfection/CellProfiler/Output/20220404_CellProfiler_NoNegVals_Image.csv", sep = ""), paste(dirPath, "20210513Transfection/CellProfiler/Output/20220404_CellProfiler_NoNegVals_Cell.csv", sep = ""))

cpOldPt1 <- readCp(paste(dirPath, "OlderExperiments/CellProfiler/Output/20220507_CellProfiler_NoNegVal_MCAM_Pt1Image.csv", sep = ""), paste(dirPath, "OlderExperiments/CellProfiler/Output/20220507_CellProfiler_NoNegVal_MCAM_Pt1Cell.csv", sep = ""))

# Three-channel images
cpOldPt2 <- readCp(paste(dirPath, "OlderExperiments/CellProfiler/Output/20220507_CellProfiler_NoNegVal_MCAM_Pt2Image.csv", sep = ""), paste(dirPath, "OlderExperiments/CellProfiler/Output/20220507_CellProfiler_NoNegVal_MCAM_Pt2Cell.csv", sep = ""))

cp1205 <- readCp(paste(dirPath, "20211205Transfection/CellProfiler/Output/20220210_CellProfiler_NoNegVals_Image.csv", sep = ""), paste(dirPath, "20211205Transfection/CellProfiler/Output/20220210_CellProfiler_NoNegVals_Cell.csv", sep = "")) %>%
  rename_with(~gsub("Mcam", 'Main', .x), .cols = everything())  %>%
  rename_with(~gsub("Factin", 'Third', .x), .cols = everything())

cp0509 <- readCp(paste(dirPath, "20220509Transfection/CellProfiler/Output/20220523_CellProfiler_NoNegVal_20220509TfnImage.csv", sep = ""), paste(dirPath, "20220509Transfection/CellProfiler/Output/20220523_CellProfiler_NoNegVal_20220509TfnCell.csv", sep = ""))

cp0530 <- readCp(paste(dirPath, "20220530Transfection/CellProfiler/Output/20220612_CellProfiler_NoNegVal_20220530TfnImage.csv", sep = ""), paste(dirPath, "20220530Transfection/CellProfiler/Output/20220612_CellProfiler_NoNegVal_20220530TfnCell.csv", sep = ""))

# Check column names match after renaming according to updated format (setdiff should be empty)
setdiff(colnames(cp1205), colnames(cpOldPt2))

cp2channel <- rbind(cp0513, cpOldPt1)
cp3channel <- rbind(cpOldPt2, cp1205, cp0509, cp0530)
```

Matlab files:
```{r}
matlab0513 <- importMatlabMulti(paste(dirPath, "20210513Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Cell_20220404.csv", sep = ""), paste(dirPath, "20210513Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_MCAM_20220404.csv", sep = ""), paste(dirPath, "20210513Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Other_20220404.csv", sep = ""), "empty", annotation0513, "MCAM", "Other", "empty")

matlabOld <- importMatlabMulti(paste(dirPath, "OlderExperiments/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Cell_20220506.csv", sep = ""), paste(dirPath, "OlderExperiments/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_MCAM_20220506.csv", sep = ""), paste(dirPath, "OlderExperiments/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Other_20220506.csv", sep = ""), paste(dirPath, "OlderExperiments/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Factin_20220506.csv", sep=""), annotationOld, "MCAM", "Other", "Third")
# Image 22_Cov1_001 was duplicated in Matlab analysis, but duplicate rows are removed during import

matlab1205 <- importMatlabMulti(paste(dirPath, "20211205Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Cell_20220410.csv", sep = ""), paste(dirPath, "20211205Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_MCAM_20220410.csv", sep = ""), paste(dirPath, "20211205Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Other_20220410.csv", sep = ""),
                                paste(dirPath, "20211205Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Factin_20220410.csv", sep = ""), annotation1205, "MCAM", "Other", "Third") 
#Note some images conveniently from RDX knockdown were removed from original analysis but included here

matlab0509Pt1 <- importMatlabMulti(paste(dirPath, "20220509Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Cell_20220521.csv", sep = ""), paste(dirPath, "20220509Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_MCAM_20220521.csv", sep = ""), paste(dirPath, "20220509Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Other_20220521.csv", sep = ""),
                                paste(dirPath, "20220509Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Factin_20220521.csv", sep = ""), annotation0509, "MCAM", "Other", "Third")

matlab0509Pt2 <- importMatlabMulti(paste(dirPath, "20220509Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Cell_20220522.csv", sep = ""), paste(dirPath, "20220509Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_MCAM_20220522.csv", sep = ""), paste(dirPath, "20220509Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Other_20220522.csv", sep = ""),
                                paste(dirPath, "20220509Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Factin_20220522.csv", sep = ""), annotation0509, "MCAM", "Other", "Third")

matlab0509 <- rbind(matlab0509Pt1, matlab0509Pt2)
remove(matlab0509Pt1)
remove(matlab0509Pt2)

matlab0530 <- importMatlabMulti(paste(dirPath, "20220530Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Cell_20220611.csv", sep = ""), paste(dirPath, "20220530Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_MCAM_20220611.csv", sep=""), paste(dirPath, "20220530Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Other_20220611.csv", sep = ""),
                                paste(dirPath, "20220530Transfection/MatlabAnalysis/WrampMetrics/Output/80thPctlNoCloseStats_Factin_20220611.csv", sep = ""), annotation0530, "MCAM", "Other", "Third")

matlab2channel <- rbind(matlab0513 %>%
  dplyr::select(-TxRed), 
                        matlabOld %>% 
                          filter(Object %in% cpOldPt1$Object) %>% 
                          dplyr::select(all_of(colnames(matlab0513 %>% dplyr::select(-TxRed))))) %>%
  dplyr::select(-all_of(c("DAPI", "FITC")))

matlab3channel <- rbind(matlabOld %>% 
                          filter(Object %in% cpOldPt2$Object) %>% 
                          dplyr::select(-all_of(c("DAPI", "FITC", "TxRedCy5"))), 
                        matlab1205,
                        matlab0509 %>%
                          dplyr::select(-all_of(c("DAPI", "FITC", "TxRedCy5"))),
                        matlab0530 %>%
                          dplyr::select(-all_of(c("DAPI", "FITC", "TxRedCy5"))))

# Check that object names match in Matlab and CellProfiler dataframes (setdiff should be empty)
setdiff(matlab2channel$Object, cp2channel$Object)
setdiff(matlab3channel$Object, cp3channel$Object) # Note: cp files are usually several rows longer because Matlab skips segmented objects that fail the function (usually very weirdly shaped mask from debris or rounded cell that the function can't accomodate)
```

Combine and clean features
```{r}
metricsClean2Channel <- combineMetrics(matlab2channel, cp2channel, "_BgSubtractedMain", "_BgSubtractedOther", "empty", "MCAM", "Other", "empty")

metricsClean3Channel  <- combineMetrics(matlab3channel, cp3channel, "_BgSubtractedMain", "_BgSubtractedOther", "_BgSubtractedThird", "MCAM", "Other", "Third")

# write_csv(metricsClean2Channel, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/metricsClean_2Channel_Thesis_20221104test.csv", sep = ""))
# write_csv(metricsClean3Channel, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/metricsClean_3Channel_Thesis_20221104test.csv", sep = ""))
```

Compile 2- and 3-channel datasets (removing 3rd channel - phalloidin)
```{r}
# Remove images which don't have MCAM (mouse) staining
metricsCleanMcamOtherAllMcam488 <- rbind(metricsClean2Channel,
                               metricsClean3Channel %>% dplyr::select(-all_of(setdiff(colnames(metricsClean3Channel), colnames(metricsClean2Channel))))) %>%
    filter(Exclude != "Omit" | is.na(Exclude), 
           !str_detect(Replicate, "StainCD44"), 
           !str_detect(Replicate, "StainMCAMC"),
           !str_detect(Image, "RDX488")) %>% # Stained using rabbit MCAM antibody or no MCAM
    filter(str_detect(Condition, "StainMCAM-")) # Redundancy

# write_csv(metricsCleanMcamOtherAllMcam488, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/metricsClean_McamOtherAllMcam488_Thesis_20221104test_20231004.csv", sep = ""))
```

Scale and normalize features:
```{r}
normAreaFeaturesGeneric <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/InputForML/ScalingValues/normAreaFeatures.csv", sep = ""))[,"x"]

normAreaFeatures.MCAM <- normAreaFeaturesChannel(normAreaFeaturesGeneric, "MCAM")

medianAreas.MCAM <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/InputForML/ScalingValues/medianAreasMcam.csv", sep = ""))

colocFeatures <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/InputForML/ScalingValues/colocalizationFeatures.csv", sep = ""))[,"x"]

metricsScaled.MCAM <- scaleAreaIntensity(metricsCleanMcamOtherAllMcam488, 
                                         normAreaFeatures.MCAM, medianAreas.MCAM, colocFeatures, "MCAM", "_BgSubtractedMain")
metricsScaled.MCAM %>% filter_if(is.numeric, any_vars(is.nan(.)))
metricsCleanMcamOtherAllMcam488 %>% filter(Object == "23_Cov1_001.nd2_17") # Median intensity was 0 so Inf and NaN introduced. This is from February experiment which was not included in paper.

write_csv(metricsScaled.MCAM, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/metricsScaled_McamOtherAllMcam488_Thesis_20221104test_CorrectedCondition_20231004_test.csv", sep = ""))
```

Remove data for extraneous knockdown conditions, different IF staining, excluded experiments, etc.

Note that the cells used for training the classifier and the results reported in the first submission of the paper included images from the 20210406_KD from "Coverslip 2" (Cov2). After submitting, it was realized that these coverslips were not replicates of "Coverslip 1" but were cells treated with a lower concentration of Lipofectamine 3000. These images were all part of the EZR knockdown condition. The code below filters out the incorrectly labeled images.
```{r}
xlabel <- data.frame(mainCondition = c("siCntr", "siEZR", "siRDX", "siMSN"), 
                     xlabel = factor(c("Control", "EZR", "RDX", "MSN"), levels = c("Control", "MSN", "EZR", "RDX")))

# "Pre-filtered" data is removes conditions that did not have MCAM staining or were part of experiments which were not true replicates.
# Revised to remove 20210406 "Cov2" samples (used 2 uL lipofectamine instead of 4)
metricsCleanMcamOtherMcam488.PreFilt <- metricsCleanMcamOtherAllMcam488 %>%
  filter(!Image %in% excludeImages) %>% 
  filter(Exclude != "Omit" | is.na(Exclude)) %>% 
  filter(!str_detect(Replicate, "StainCD44"), 
           !str_detect(Replicate, "StainMCAMC"),
           !str_detect(Image, "RDX488")) %>% # Stained using rabbit MCAM antibody or no MCAM
  filter(str_detect(Condition, "StainMCAM-")) %>%
  filter(!experimentGroup %in% c("20210513KD")) %>% # Using manual scoring to estimate results
  filter(Experiment != "20210210_EzrinKD") %>% # Not a replicate condition
  filter(mainRep != "20211205_siRhoA") %>%  # This removes siRhoA images (not control siRNA images with MCAM-ROCK1/2 staining)
  filter(!str_detect(Experiment, "20211205_KD_RDX")) %>% # Images appear to be mislabeled
  filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) # Not a replicate condition

metricsCleanMcamOtherMcam488.PreFilt %>% filter(experimentGroup == "20210406KD") %>% count(Coverslip)
metricsCleanMcamOtherAllMcam488 %>% filter(!Object %in% metricsCleanMcamOtherMcam488.PreFilt$Object) %>% count(Coverslip)
metricsCleanMcamOtherAllMcam488 %>% filter(Image %in% excludeImages) %>% count(Coverslip)

# "Filtered" data removes the experiments which were excluded based on Dixon's Q test or undersampling. It is the data reported in the paper.
metricsCleanMcamOtherMcam488.Filt <- metricsCleanMcamOtherMcam488.PreFilt %>%
  filter(!Image %in% excludeImages) %>% 
  filter(Exclude != "Omit" | is.na(Exclude)) %>% 
  filter(!str_detect(Replicate, "StainCD44"), 
           !str_detect(Replicate, "StainMCAMC"),
           !str_detect(Image, "RDX488")) %>% # Stained using rabbit MCAM antibody or no MCAM
  filter(str_detect(Condition, "StainMCAM-")) %>%
  filter(!experimentGroup %in% c("20210513KD")) %>% # Not included because IF samples were prepared differently
  filter(!Experiment %in% c("20210723_KD1", "20210726_KD1", "20210805_KD3")) %>% # Not included in Figure 6 (met exclusion criteria as described in Supplemental Figure)
  filter(Experiment != "20210210_EzrinKD") %>% # Not a replicate condition
  filter(mainRep != "20211205_siRhoA") %>%  # This removes siRhoA images (not control siRNA images with MCAM-ROCK1/2 staining)
  filter(!str_detect(Experiment, "20211205_KD_RDX")) %>% # Control and KD conditions may have been mixed up 
  merge(xlabel, by = "mainCondition") %>%
  dplyr::mutate(Condition = str_remove(Condition, "_KD.*")) %>%
  arrange(Experiment)

nrow(metricsCleanMcamOtherMcam488.PreFilt %>% filter(!Object %in% metricsCleanMcamOtherMcam488.Filt$Object)) + nrow(metricsCleanMcamOtherMcam488.PreFilt %>% filter(Object %in% metricsCleanMcamOtherMcam488.Filt$Object))

# Removed excluded experiments
metricsCleanMcamOtherMcam488.PreFilt %>% filter(!Object %in% metricsCleanMcamOtherMcam488.Filt$Object) %>% group_by(Experiment) %>% count(Coverslip) %>% ungroup()

unique(metricsCleanMcamOtherMcam488.Filt$Condition)
unique(metricsCleanMcamOtherMcam488.Filt$Experiment)

# Filtered scaled features
metricsScaled.MCAM.PreFilt <- metricsScaled.MCAM %>% filter(Object %in% metricsCleanMcamOtherMcam488.PreFilt$Object)
metricsScaled.MCAM.Filt <- metricsScaled.MCAM %>% filter(Object %in% metricsCleanMcamOtherMcam488.Filt$Object)

metricsCleanMcamOtherMcam488.Filt %>%
  group_by(experimentGroup, xlabel, mainCondition, mainRep) %>% count(Replicate)
```

Use ML model trained in separate notebook to classify the data:
```{r}
mcamKDmodel2_85 <- readRDS(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ClassifiersForMcam/modelList20221104-NoTexture_85up", sep = ""))

metricsCleanMcamOtherMcam488.Classified.Filt <- classifyCleanMetricsCombinedModels(metricsCleanMcamOtherMcam488.Filt, 
                                                                       metricsScaled.MCAM.Filt, 
                                                                       mcamKDmodel2_85[["fittedModels"]][["gbmTwo"]],
                                                                       mcamKDmodel2_85[["fittedModels"]][["extraTreesTwo"]], 
                                                                       columnName = "comboGbmExtraTwo_MCAM2") %>%
  dplyr::mutate(Experiment = ifelse(Experiment == "20210723_KD1", "20210726_KD1", Experiment))

metricsCleanMcamOtherMcam488.Classified.PreFilt <- classifyCleanMetricsCombinedModels(metricsCleanMcamOtherMcam488.PreFilt, 
                                                                       metricsScaled.MCAM.PreFilt, 
                                                                       mcamKDmodel2_85[["fittedModels"]][["gbmTwo"]],
                                                                       mcamKDmodel2_85[["fittedModels"]][["extraTreesTwo"]], 
                                                                       columnName = "comboGbmExtraTwo_MCAM2") %>%
  dplyr::mutate(Experiment = ifelse(Experiment == "20210723_KD1", "20210726_KD1", Experiment))

metricsCleanMcamOtherMcam488.Classified <- classifyCleanMetricsCombinedModels(metricsCleanMcamOtherAllMcam488, 
                                                                       metricsScaled.MCAM, 
                                                                       mcamKDmodel2_85[["fittedModels"]][["gbmTwo"]],
                                                                       mcamKDmodel2_85[["fittedModels"]][["extraTreesTwo"]], 
                                                                       columnName = "comboGbmExtraTwo_MCAM2") %>%
  dplyr::mutate(Experiment = ifelse(Experiment == "20210723_KD1", "20210726_KD1", Experiment))

# write_csv(metricsCleanMcamOtherMcam488.Classified.PreFilt, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/metricsCleanClassified_PreFiltered_20231004.csv", sep=""))
write_csv(metricsCleanMcamOtherMcam488.Classified.Filt, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/metricsCleanClassified_Filtered_20231004_test.csv", sep=""))

identical(metricsCleanMcamOtherMcam488.Classified.PreFilt %>% dplyr::select(Object, comboGbmExtraTwo_MCAM2), metricsCleanMcamOtherMcam488.Classified %>% filter(Object %in% metricsCleanMcamOtherMcam488.Classified.PreFilt$Object) %>% dplyr::select(Object, comboGbmExtraTwo_MCAM2))

identical(metricsCleanMcamOtherMcam488.Classified.Filt %>% dplyr::select(Object, comboGbmExtraTwo_MCAM2), metricsCleanMcamOtherMcam488.Classified %>% filter(Object %in% metricsCleanMcamOtherMcam488.Classified.Filt$Object) %>% dplyr::select(Object, comboGbmExtraTwo_MCAM2))

```

Manual scoring used in ML:
```{r}
manualScoringTemp <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/InputForML/manualScoringNoCopolar_20221104_New.csv", sep = "")) 
manualScoring <- manualScoringTemp %>%
  filter(!Image %in% excludeImages) %>% 
  filter(Exclude != "Omit" | is.na(Exclude)) %>% 
  filter(!str_detect(Replicate, "StainCD44"), 
           !str_detect(Replicate, "StainMCAMC"),
           !str_detect(Image, "RDX488")) %>% # Stained using rabbit MCAM antibody or no MCAM
  filter(str_detect(Condition, "StainMCAM-")) %>%
  filter(!experimentGroup %in% c("20210513KD")) %>%
  filter(!Experiment %in% c("20210723_KD1", "20210726_KD1", "20210805_KD3")) %>% # Not included in paper (met exclusion criteria described in Statistics in Supplemental Material)
  filter(Experiment != "20210210_EzrinKD") %>% # Not a replicate condition
  filter(mainRep != "20211205_siRhoA") %>%  # This removes siRhoA images (not control siRNA images with MCAM-ROCK1/2 staining)
  filter(!str_detect(Experiment, "20211205_KD_RDX")) %>% # Control and KD conditions may have been mixed up 
  merge(xlabel, by = "mainCondition") %>%
  dplyr::mutate(Condition = str_remove(Condition, "20220509_")) %>% # Fix problem with annotation file
  dplyr::mutate(Condition = str_remove(Condition, "_KD.*")) %>%
  arrange(Experiment)

nTrainPerExperiment <- manualScoring %>% group_by(experimentGroup) %>% count(xlabel) %>%
  ungroup()
nrow(merge(metricsCleanMcamOtherMcam488.Classified.Filt, manualScoringTemp, by = "Object"))

nPerExperiment <- metricsCleanMcamOtherMcam488.Classified.Filt %>% group_by(experimentGroup) %>% count(xlabel)

unique(manualScoring$Condition)

# Check that filtering works correctly. Note that this is the original version, which incorrectly includes 20210406 Cov2
setdiff(manualScoring$Object, metricsCleanMcamOtherMcam488.Classified.Filt$Object) # 20210406 Cov2
manualScoring %>% filter(Object %in% setdiff(manualScoring$Object, metricsCleanMcamOtherMcam488.Classified.Filt$Object)) %>% count(Coverslip)
test <- metricsCleanMcamOtherMcam488.Classified.Filt %>% filter(Object %in% manualScoringTemp$Object)
setdiff(test$Object, manualScoring$Object)
setdiff(manualScoring$Object, test$Object)
manualScoring %>% filter(Object %in% setdiff(manualScoring$Object, test$Object)) %>% count(Coverslip)
remove(test)
metricsCleanMcamOtherMcam488.Classified.Filt %>% filter(Object %in% manualScoringTemp$Object) %>% count(Coverslip)
```

Accuracy of excluded experiments. Note: no additional cells were scored in Sept. 2023 for these experiments. However, they were not included in the iterative training of the classifier so the original scoring is independent of the training set.

High Confidence Sensitivity/Specificity/Precision:
20210805KD Control siRNA: 100/85/67%
20210805KD RDX siRNA: 88/81/64%
20210726KD Control siRNA: 80/92/61%
20210726KD EZR siRNA: 83/82/53%
20210726KD MSN siRNA: 100/93/60%
20210726KD RDX siRNA: 85/87/48%
```{r}
analyzeResults2(metricsCleanMcamOtherMcam488.Classified.PreFilt %>%
                  merge(manualScoringTemp %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam, Segmentation), by = "Object") %>%
                  filter(is.na(Segmentation)) %>%
                  filter(!Object %in% mcamKDmodel2_85[["trainingSets"]][["Two"]]) %>%
                  filter(experimentGroup == "202107KD") %>%
                  dplyr::mutate(mainRep = ifelse(str_detect(mainRep, "20210723"), str_replace(mainRep, "20210723", "20210726"), mainRep)),
                "comboGbmExtraTwo_MCAM2", "ManualScoreMcam", "mainRep")
```

Percent of polarized cells by coverslip:
```{r}
percCoverslip <- metricsCleanMcamOtherMcam488.Classified.PreFilt %>%
  filter(str_detect(Condition, "StainMCAM-")) %>%
  dplyr::select(comboGbmExtraTwo_MCAM2, mainCondition, mainRep, experimentGroup, Coverslip) %>%
  dplyr::mutate(class = comboGbmExtraTwo_MCAM2) %>%
  dplyr::mutate_at("class", function(x){x = as.character(x)
                             x = ifelse(x == "BothEnds", "None", x)
                             x = factor(x, levels = c("OneEnd", "None"))}) %>%
  group_by(experimentGroup, mainCondition, mainRep, Coverslip) %>%
  count(class) %>%
  dplyr::mutate(perc = n/(sum(n))*100, nTot = sum(n)) %>%
  ungroup() %>%
  filter(class == "OneEnd")
```

Plots of percent of polarized cells by coverslip for each experimentGroup (currently including 20210406 "Cov2" samples and 20211205 RDX KD):
```{r}
ggplot(percCoverslip %>%
  filter(experimentGroup == "20210406KD"),
  aes(x = Coverslip, y = perc, fill = mainCondition)) +
  geom_col() +
  ylim(0,100) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# ggplot(metricsCleanMcamOtherMcam488.Classified %>%
#   filter(experimentGroup == "20210406KD"),
#   aes(x = Coverslip, y = meanIntensityCell_Other, color = mainRep)) + geom_boxplot() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1))
# 
# ggplot(metricsCleanMcamOtherMcam488.Classified %>%
#   filter(experimentGroup == "20210406KD"),
#   aes(x = Coverslip, y = sumIntensityCell_Other, color = mainRep)) + geom_boxplot() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1))


ggplot(percCoverslip %>%
  filter(experimentGroup == "202107KD"),
  aes(x = Coverslip, y = perc, fill = mainCondition)) +
  geom_col() +
  ylim(0,100) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


ggplot(percCoverslip %>%
  filter(str_detect(mainRep, "20210726") | str_detect(mainRep, "20210723")),
  aes(x = Coverslip, y = perc, fill = mainCondition)) +
  geom_col() +
  ylim(0,100) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggplot(percCoverslip %>%
  filter(str_detect(mainRep, "20210728")),
  aes(x = Coverslip, y = perc, fill = mainCondition)) +
  geom_col() +
  ylim(0,100) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggplot(percCoverslip %>%
  filter(str_detect(mainRep, "20210805")),
  aes(x = Coverslip, y = perc, fill = mainCondition)) +
  geom_col() +
  ylim(0,100) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# ggplot(metricsCleanMcamOtherMcam488.Classified %>%
#   filter(experimentGroup == "202107KD", !str_detect(Condition, "Myosin")),
#   aes(x = Coverslip, y = meanIntensityCell_Other, color = mainRep)) + geom_boxplot() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1))
# 
# ggplot(metricsCleanMcamOtherMcam488.Classified %>%
#   filter(experimentGroup == "202107KD",  !str_detect(Condition, "Myosin")),
#   aes(x = Coverslip, y = sumIntensityCell_Other, color = mainRep)) + geom_boxplot() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1))


ggplot(percCoverslip %>%
  filter(experimentGroup == "20211205KD"),
  aes(x = Coverslip, y = perc, fill = mainCondition)) +
  geom_col() +
  ylim(0,100) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# ggplot(metricsCleanMcamOtherMcam488.Classified %>%
#   filter(experimentGroup == "20211205KD", !str_detect(Condition, "Myosin")),
#   aes(x = Coverslip, y = meanIntensityCell_Other, color = mainRep)) + geom_boxplot() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1))
# 
# ggplot(metricsCleanMcamOtherMcam488.Classified %>%
#   filter(experimentGroup == "20211205KD",  !str_detect(Condition, "Myosin")),
#   aes(x = Coverslip, y = sumIntensityCell_Other, color = mainRep)) + geom_boxplot() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1))


ggplot(percCoverslip %>%
  filter(experimentGroup == "20220509KD"),
  aes(x = Coverslip, y = perc, fill = mainCondition)) +
  geom_col() +
  ylim(0,100) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# ggplot(metricsCleanMcamOtherMcam488.Classified %>%
#   filter(experimentGroup == "20220509KD", !str_detect(Condition, "Myosin")),
#   aes(x = Coverslip, y = meanIntensityCell_Other, color = mainRep)) + geom_boxplot() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1))
# 
# ggplot(metricsCleanMcamOtherMcam488.Classified %>%
#   filter(experimentGroup == "20220509KD",  !str_detect(Condition, "Myosin")),
#   aes(x = Coverslip, y = sumIntensityCell_Other, color = mainRep)) + geom_boxplot() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1))


ggplot(percCoverslip %>%
  filter(experimentGroup == "20220530KD"),
  aes(x = Coverslip, y = perc, fill = mainCondition)) +
  geom_col() +
  ylim(0,100) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# ggplot(metricsCleanMcamOtherMcam488.Classified %>%
#   filter(experimentGroup == "20220530KD", !str_detect(Condition, "Myosin")),
#   aes(x = Coverslip, y = meanIntensityCell_Other, color = mainRep)) + geom_boxplot() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1))
# 
# ggplot(metricsCleanMcamOtherMcam488.Classified %>%
#   filter(experimentGroup == "20220530KD",  !str_detect(Condition, "Myosin")),
#   aes(x = Coverslip, y = sumIntensityCell_Other, color = mainRep)) + geom_boxplot() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Preparing for creating and analyzing a new validation set to show accuracy of ML classification (added because the test set used in initial evaluation of ML classifier was not independent of training set after the first iteration of training).

Looking at images used in training:
```{r}
# 457 images analyzed (after removing 20210406 "Cov2")
allImages <- unique(metricsCleanMcamOtherMcam488.Classified.Filt %>% dplyr::select(Image))

# 355 of 457 images used in training sets
imagesInAnyTrain <- unique(metricsCleanMcamOtherMcam488.Classified.Filt %>% 
              filter(Object %in% mcamKDmodel2_85[["trainingSets"]][["Two"]] | Object %in% mcamKDmodel2_85[["trainingSets"]][["One"]] | Object %in% mcamKDmodel2_85[["trainingSets"]][["Zero"]]) %>%
              dplyr::select(Image, Coverslip))

# Images not used in training sets
unique(metricsCleanMcamOtherMcam488.Classified.Filt %>%
  filter(!Image %in% imagesInAnyTrain$Image) %>%
  dplyr::select(Image, mainRep)) %>%
  count(mainRep)

unique(metricsCleanMcamOtherMcam488.Classified.Filt$mainRep)

# 6 coverslips not used in training sets
unique(metricsCleanMcamOtherMcam488.Classified.Filt %>%
           filter(!Coverslip %in% unique(imagesInAnyTrain$Coverslip)) %>%
  dplyr::select(Coverslip, mainRep)) %>%
  count(mainRep)
```

Proportion of polarized cells based on ML classification when leaving out manually scored cells is fairly similar to % across all cells
```{r}
percWramp.NotTraining.Mcam <- metricsCleanMcamOtherMcam488.Classified.Filt %>%
    dplyr::rename(classification = comboGbmExtraTwo_MCAM2) %>%
    filter(!Object %in% manualScoring$Object) %>%
    dplyr::select(experimentGroup, mainCondition, mainRep, classification) %>%
    group_by(experimentGroup, mainCondition, mainRep) %>%
      count(classification) %>%
    dplyr::mutate(perc = n/sum(n)*100, nTot = sum(n)) %>%
    ungroup() %>%
    filter(classification == "OneEnd")
```

Number of cell/class after removing previously manually scored cells:
```{r}
metricsCleanMcamOtherMcam488.Classified.Filt %>%
  filter(!Object %in% manualScoring$Object) %>%
  dplyr::mutate(mainRep = str_remove(Replicate, "_Stain.*")) %>%
  group_by(mainRep) %>%
  count(comboGbmExtraTwo_MCAM2) %>%
  ungroup()

metricsCleanMcamOtherMcam488.Classified.Filt %>%
  filter(!Object %in% manualScoring$Object) %>%
  dplyr::mutate(mainRep = str_remove(Replicate, "_Stain.*")) %>%
  count(mainRep)
```

First set of 120 cells sampled per replicate (was sample before removing the incorrectly annotated "Cov2" images from 20210406KD):
```{r}
originalFilt <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ThesisAndFirstSubmission/metricsCleanClassified_UsedInPlots.csv", sep=""))

set.seed(135)
sample1 <- originalFilt %>%
  arrange(Object) %>%
   filter(!Object %in% manualScoring$Object) %>%
   group_by(mainRep) %>%
   slice_sample(n = 120, replace = F) %>%
  ungroup()

coverslips <- unique(originalFilt$Coverslip)
setdiff(coverslips, sample1$Coverslip) # covers all coverslips
length(unique(sample1$Image)) # 446 out of 470 images
setdiff(allImages$Image, sample1$Image) # 24 images
setdiff(sample1$Image, imagesInAnyTrain$Image) # 98 images not in training
sample1 %>% filter(!Image %in% imagesInAnyTrain$Image) %>%
  count(Image)

sample1 %>% group_by(mainRep) %>% count(comboGbmExtraTwo_MCAM2) %>% ungroup()
sample1 %>% count(Coverslip)

# write_csv(sample1, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ValidationSample1_Seed135_20230901.csv", sep = ""))
```

Second set with different seed (not used):
```{r}
set.seed(234)
sample2 <- originalFilt %>%
  arrange(Object) %>%
   filter(!Object %in% manualScoring$Object) %>%
   group_by(mainRep) %>%
   slice_sample(n = 120, replace = F) %>%
   ungroup()

coverslips <- unique(originalFilt$Coverslip)
setdiff(coverslips, sample2$Coverslip) # covers all coverslips
length(unique(sample2$Image)) # 431 out of 470 images
setdiff(allImages$Image, sample2$Image) # 39 images
setdiff(sample2$Image, imagesInAnyTrain$Image) # 90 images not in training
setdiff(imagesInAnyTrain$Image, sample2$Image)
sample2 %>% filter(!Image %in% imagesInAnyTrain$Image) %>%
  count(Image)

sample2 %>% group_by(mainRep) %>% count(comboGbmExtraTwo_MCAM2) %>% ungroup()
sample2 %>% count(Coverslip)

# write_csv(sample2, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ValidationSample2_Seed234_20230901.csv", sep = ""))
```

Randomly shuffle, blind images, and copy for validation scoring:
```{r}
sample1 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/ValidationSample1_Seed135_20230901.csv", sep = ""))
sum(duplicated(sample1$Object))

nrow(sample1 %>% filter(Object %in% manualScoring$Object))
nrow(sample1 %>% filter(Object %in% manualScoringTemp$Object))
manualScoring %>% count(Segmentation)
manualScoring %>% count(WrongObject)

nrow(sample1 %>% filter(Object %in% mcamKDmodel2_85[["trainingSets"]][["Two"]]))
nrow(sample1 %>% filter(Object %in% mcamKDmodel2_85[["trainingSets"]][["One"]]))
nrow(sample1 %>% filter(Object %in% mcamKDmodel2_85[["trainingSets"]][["Zero"]]))

# # Shuffle cells
# nCells <- length(sample1$Object)
# set.seed(123)
# fileNameV1 <- paste(gsub(".nd2", "_Img_Cell", sample1$Object)[sample(nCells, nCells, replace = F)], "_80thPctlNoClose.png", sep = "")
# fileNameV2 <- gsub("_80thPctlNoClose.png", "_Img_Cell_80thPctlNoClose.png", gsub("_Img_Cell", "", fileNameV1))
# 
# renameMatrix <- data.frame(newNum = 1:nCells, imgNameV1 = fileNameV1, imgNameV2 = fileNameV2) %>%
#   dplyr::mutate(newNameImg = paste("80thPctlNoClose_", as.character(newNum), "_Img.png", sep = ""),
#          newNameFig = paste("80thPctlNoClose_", as.character(newNum), "_Fig.png", sep = ""),
#          figNameV1 = paste("Bg_", str_replace(imgNameV1, "Img", "Figure"), sep = ""),
#          figNameV2 = str_replace(imgNameV2, "Img", "Figure")) %>%
#    dplyr::mutate(pathNameImgV1 = paste(dirPath, "AllKDFigures/", imgNameV1, sep = ""),
#           pathNameImgV2 = paste(dirPath, "AllKDFigures/", imgNameV2, sep = ""),
#           pathNameFigV1 = paste(dirPath, "AllKDFigures/", figNameV1, sep = ""),
#           pathNameFigV2 = paste(dirPath, "AllKDFigures/", figNameV2, sep = "")) %>%
#   dplyr::mutate(toPathNameImgV1 = paste(dirPath, "ValidationSample1_20230901/", imgNameV1, sep = ""),
#           toPathNameImgV2 = paste(dirPath, "ValidationSample1_20230901/", imgNameV2, sep = ""),
#           toPathNameFigV1 = paste(dirPath, "ValidationSample1_20230901/", figNameV1, sep = ""),
#           toPathNameFigV2 = paste(dirPath, "ValidationSample1_20230901/", figNameV2, sep = ""))
# 
# file.copy(from = renameMatrix$pathNameImgV1, to = renameMatrix$toPathNameImgV1)
# file.copy(from = renameMatrix$pathNameImgV2, to = renameMatrix$toPathNameImgV2)
# file.copy(from = renameMatrix$pathNameFigV1, to = renameMatrix$toPathNameFigV1)
# file.copy(from = renameMatrix$pathNameFigV2, to = renameMatrix$toPathNameFigV2)
# 
# setwd(paste(dirPath, "ValidationSample1_20230901/", sep = ""))
# write.csv(renameMatrix, "Blinding_ValidationSample1_20230901.csv")
# file.rename(renameMatrix$imgNameV1, renameMatrix$newNameImg)
# file.rename(renameMatrix$imgNameV2, renameMatrix$newNameImg)
# file.rename(renameMatrix$figNameV1, renameMatrix$newNameFig)
# file.rename(renameMatrix$figNameV2, renameMatrix$newNameFig)

test <- read.csv(paste(dirPath, "ValidationSample1_20230901/Blinding_ValidationSample1_20230901.csv", sep = ""))

test2 <- test %>%
  dplyr::mutate(Object = str_remove(imgNameV1, "_80thPctlNoClose.png")) %>%
  dplyr::mutate(Object = str_replace(Object, "_Img_Cell", ".nd2"))

setdiff(test2$Object, sample1$Object)
setdiff(sample1$Object, test2$Object)
```

New validation scoring:
```{r}
scoringValid0901 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/InputForML/manualScoring_ValidationSample1_20230901_Final.csv", sep = ""))

# Check:
setdiff(scoringValid0901$Object, sample1$Object)
nrow(scoringValid0901 %>% filter(Object %in% manualScoring$Object))
nrow(scoringValid0901 %>% filter(Object %in% manualScoringTemp$Object))

nrow(scoringValid0901 %>% filter(Object %in% mcamKDmodel2_85[["trainingSets"]][["Two"]]))
nrow(scoringValid0901 %>% filter(Object %in% mcamKDmodel2_85[["trainingSets"]][["One"]]))
nrow(scoringValid0901 %>% filter(Object %in% mcamKDmodel2_85[["trainingSets"]][["Zero"]]))
```

How many high-confidence and low-confidence manual classifications: (Note: 20210406KD EZR siRNA condition includes cells from "Cov2" images, but these had a different concentration of Lipofectamine)
```{r}
scoringValid0901 %>%
  filter(is.na(Segmentation)) %>%
  group_by(ManualScoreMcam, mainCondition) %>%
  count(ConfidenceMcam) %>%
  dplyr::mutate(perc = n/sum(n), nTot = sum(n)) %>%
  ungroup()

confValid0901 <- scoringValid0901 %>%
  filter(is.na(Segmentation)) %>%
  group_by(ManualScoreMcam, experimentGroup, mainCondition) %>%
  count(ConfidenceMcam) %>%
  dplyr::mutate(perc = n/sum(n), nTot = sum(n)) %>%
  ungroup() %>%
  dplyr::mutate(ConfidenceMcam = as.character(ConfidenceMcam))

confOldScoring <- manualScoring %>%
  filter(is.na(Segmentation)) %>%
  group_by(ManualScoreMcam, experimentGroup, mainCondition) %>%
  count(ConfidenceMcam) %>%
  dplyr::mutate(perc = n/sum(n), nTot = sum(n)) %>%
  ungroup() %>%
  dplyr::mutate(ConfidenceMcam = as.character(ConfidenceMcam))

clr = c("1" = "grey", "2" = "blue", "3" = "pink")

# New validation scoring:
# Plot of high and low-confidence "OneEnd" cells:
ggplot(confValid0901 %>% filter(ManualScoreMcam == "OneEnd"), aes(x = mainCondition, y = n, fill = ConfidenceMcam)) + geom_col(position="stack", color="black") +
  scale_fill_manual(values = clr) +
  facet_grid(vars(experimentGroup))

# Plot of high and low-confidence "None" cells:
ggplot(confValid0901 %>% filter(ManualScoreMcam == "None"), aes(x = mainCondition, y = n, fill = ConfidenceMcam)) + geom_col(position=position_stack(reverse = T), color="black") + 
  scale_fill_manual(values = clr) +
  facet_grid(vars(experimentGroup))

# Same plots for original manual scoring:
ggplot(confOldScoring %>% filter(ManualScoreMcam == "OneEnd"), aes(x = mainCondition, y = n, fill = ConfidenceMcam)) + geom_col(position="stack", color="black") +
  scale_fill_manual(values = clr) +
  facet_grid(vars(experimentGroup))

ggplot(confOldScoring %>% filter(ManualScoreMcam == "None"), aes(x = mainCondition, y = n, fill = ConfidenceMcam)) + geom_col(position=position_stack(reverse = T), color="black") + 
  scale_fill_manual(values = clr) +
  facet_grid(vars(experimentGroup))
```

Plots of the numbers of false negatives/positives:
```{r}
FPNs2 <- scoringValid0901 %>%
  filter(is.na(Segmentation)) %>%
  merge(metricsCleanMcamOtherMcam488.Classified.Filt %>% dplyr::select(Object, comboGbmExtraTwo_MCAM2), by = "Object") %>%
  group_by(ManualScoreMcam, mainCondition, experimentGroup) %>%
  count(comboGbmExtraTwo_MCAM2) %>%
  dplyr::mutate(perc = n/sum(n), nTot = sum(n)) %>%
  ungroup()

clr2 <- c("OneEnd" = "purple", "BothEnds" = "green", "None" = "black")
ggplot(FPNs2 %>% filter(ManualScoreMcam == "OneEnd"), aes(x = mainCondition, y = n, fill = comboGbmExtraTwo_MCAM2)) + geom_col(position="stack") +
  scale_fill_manual(values = clr2) +
  ylim(0,100) +
  facet_grid(vars(experimentGroup))

ggplot(FPNs2 %>% filter(ManualScoreMcam == "None"), aes(x = mainCondition, y = n, fill = comboGbmExtraTwo_MCAM2)) + geom_col(position="stack") +
  scale_fill_manual(values = clr2) +
  ylim(0,100) +
  facet_grid(vars(experimentGroup))

ggplot(FPNs2 %>% filter(ManualScoreMcam == "BothEnds"), aes(x = mainCondition, y = n, fill = comboGbmExtraTwo_MCAM2)) + geom_col(position="stack") +
  scale_fill_manual(values = clr2) +
  ylim(0,100) +
  facet_grid(vars(experimentGroup))

# Make a function:
plotFPN <- function(scoring, classifiedData, className, score, yLimit){
  classifiedData2 <- classifiedData %>%
    dplyr::rename(Prediction = className)
  plotData <- scoring %>%
    filter(is.na(Segmentation)) %>%
    dplyr::rename(refScore = score) %>%
    merge(classifiedData2 %>% dplyr::select(Object, Prediction), by = "Object") %>%
    group_by(refScore, mainCondition, experimentGroup) %>%
    count(Prediction) %>%
    ungroup()
  
  clr2 <- c("OneEnd" = "purple", "BothEnds" = "green", "None" = "black")
    print(ggplot(plotData %>% filter(refScore == "OneEnd"), aes(x = mainCondition, y = n, fill = Prediction)) + geom_col(position="stack") +
        scale_fill_manual(values = clr2) +
        ylim(0,yLimit) +
        ggtitle("Manual Score: OneEnd") +
        facet_grid(vars(experimentGroup)))

    print(ggplot(plotData %>% filter(refScore == "None"), aes(x = mainCondition, y = n, fill = Prediction)) + geom_col(position="stack") +
        scale_fill_manual(values = clr2) +
        ylim(0,yLimit) +
        ggtitle("Manual Score: None") +
        facet_grid(vars(experimentGroup)))
    
    print(ggplot(plotData %>% filter(refScore == "BothEnds"), aes(x = mainCondition, y = n, fill = Prediction)) + geom_col(position="stack") +
        scale_fill_manual(values = clr2) +
        ylim(0,yLimit) +
        ggtitle("ManualScore: BothEnds") +
        facet_grid(vars(experimentGroup)))
}

# All scores
plotFPN(scoringValid0901, metricsCleanMcamOtherMcam488.Classified.Filt, "comboGbmExtraTwo_MCAM2", "ManualScoreMcam", 100)


# High Confidence scores only
plotFPN(scoringValid0901 %>% filter(ConfidenceMcam != "2"), metricsCleanMcamOtherMcam488.Classified.Filt, "comboGbmExtraTwo_MCAM2", "ManualScoreMcam", 100)


# Low Confidence scores only
plotFPN(scoringValid0901 %>% filter(ConfidenceMcam == "2"), metricsCleanMcamOtherMcam488.Classified.Filt, "comboGbmExtraTwo_MCAM2", "ManualScoreMcam", 100)
```

Effects of iteration on accuracy:
```{r}
metricsCleanMcamOtherMcam488.Classified.Zero <- classifyCleanMetricsCombinedModels(metricsCleanMcamOtherMcam488.Classified.Filt, metricsScaled.MCAM.Filt,
                                                                                   mcamKDmodel2_85[["fittedModels"]][["gbmZero"]], mcamKDmodel2_85[["fittedModels"]][["extraTreesZero"]],
                                                                                   "comboGbmExtraZero_MCAM2")

metricsCleanMcamOtherMcam488.Classified.One <- classifyCleanMetricsCombinedModels(metricsCleanMcamOtherMcam488.Classified.Filt, metricsScaled.MCAM.Filt,
                                                                                   mcamKDmodel2_85[["fittedModels"]][["gbmOne"]], mcamKDmodel2_85[["fittedModels"]][["extraTreesOne"]],
                                                                                   "comboGbmExtraOne_MCAM2")


# Check that none of the new validation cells were used in any iteration of training:
nrow(scoringValid0901) == nrow(scoringValid0901 %>% 
                                 filter(!Object %in% mcamKDmodel2_85[["trainingSets"]][["Zero"]],
                                   !Object %in% mcamKDmodel2_85[["trainingSets"]][["One"]],
                                   !Object %in% mcamKDmodel2_85[["trainingSets"]][["Two"]]))

analyzeResults2(metricsCleanMcamOtherMcam488.Classified.Zero %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>%
                          dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  filter(!Object %in% mcamKDmodel2_85[["trainingSets"]][["Zero"]]) %>%
                  dplyr::mutate(All = "All"),
                "comboGbmExtraZero_MCAM2", "ManualScoreMcam", "All")

analyzeResults2(metricsCleanMcamOtherMcam488.Classified.One %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>%
                          dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  filter(!Object %in% mcamKDmodel2_85[["trainingSets"]][["One"]]) %>%
                  dplyr::mutate(All = "All"),
                "comboGbmExtraOne_MCAM2", "ManualScoreMcam", "All")

analyzeResults2(metricsCleanMcamOtherMcam488.Classified.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>%
                          dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  filter(!Object %in% mcamKDmodel2_85[["trainingSets"]][["Two"]]) %>%
                  dplyr::mutate(All = "All"),
                "comboGbmExtraTwo_MCAM2", "ManualScoreMcam", "All")

# Check removal of 20210406 "Cov2"
nrow(metricsCleanMcamOtherMcam488.Classified.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>%
                          dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object"))
metricsCleanMcamOtherMcam488.Classified.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>%
                          dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
  filter(Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2"))
  
nrow(scoringValid0901 %>%
       filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2"),
              is.na(Segmentation)))

# Check confusion matrix
metricsCleanMcamOtherMcam488.Classified.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>%
                          dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
  group_by(ManualScoreMcam) %>%
  count(comboGbmExtraTwo_MCAM2) %>%
  ungroup()

metricsCleanMcamOtherMcam488.Classified.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>%
                          dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
  filter(ConfidenceMcam != 2) %>%
  group_by(ManualScoreMcam) %>%
  count(comboGbmExtraTwo_MCAM2) %>%
  ungroup()
```

Accuracy of individual models on new validation data:
```{r}
# Length of training sets
length(mcamKDmodel2_85[["trainingSets"]][["Zero"]])
length(mcamKDmodel2_85[["trainingSets"]][["One"]])
length(mcamKDmodel2_85[["trainingSets"]][["Two"]])

# gbm models:
analyzeResults(metricsScaled.MCAM.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  dplyr::mutate(All = "All"), mcamKDmodel2_85[["fittedModels"]][["gbmZero"]],
                "ManualScoreMcam", "All")

analyzeResults(metricsScaled.MCAM.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  dplyr::mutate(All = "All"), mcamKDmodel2_85[["fittedModels"]][["gbmOne"]],
                "ManualScoreMcam", "All")

analyzeResults(metricsScaled.MCAM.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  dplyr::mutate(All = "All"), mcamKDmodel2_85[["fittedModels"]][["gbmTwo"]],
                "ManualScoreMcam", "All")

#extraTrees models:
analyzeResults(metricsScaled.MCAM.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  dplyr::mutate(All = "All"), mcamKDmodel2_85[["fittedModels"]][["extraTreesZero"]],
                "ManualScoreMcam", "All")

analyzeResults(metricsScaled.MCAM.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  dplyr::mutate(All = "All"), mcamKDmodel2_85[["fittedModels"]][["extraTreesOne"]],
                "ManualScoreMcam", "All")

analyzeResults(metricsScaled.MCAM.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  dplyr::mutate(All = "All"), mcamKDmodel2_85[["fittedModels"]][["extraTreesTwo"]],
                "ManualScoreMcam", "All")
```

Accuracy by condition/replicate
```{r}
# Final model
analyzeResults2(metricsCleanMcamOtherMcam488.Classified.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  filter(!Object %in% mcamKDmodel2_85[["trainingSets"]][["Two"]]),
                "comboGbmExtraTwo_MCAM2", "ManualScoreMcam", "mainCondition")

# Check
nrow(metricsCleanMcamOtherMcam488.Classified.Filt %>%
                  merge(scoringValid0901 %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object")) == nrow(metricsCleanMcamOtherMcam488.Classified.Filt %>%
                  merge(scoringValid0901 %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  filter(!Object %in% mcamKDmodel2_85[["trainingSets"]][["Two"]]))

# Check number of cells
metricsCleanMcamOtherMcam488.Classified.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  group_by(mainCondition) %>%
                  count(ConfidenceMcam) %>%
                  dplyr::mutate(nTot = sum(n), nTot - n) %>%
                  ungroup()
  

scoringValid0901 %>% filter(is.na(Segmentation)) %>%
  filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) %>%
    group_by(mainCondition) %>%
    count(ConfidenceMcam) %>%
    dplyr::mutate(nTot = sum(n), nTot - n) %>%
    ungroup()

scoringValid0901 %>% filter(is.na(Segmentation)) %>%
  filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) %>%
  dplyr::mutate(wramp = ifelse(ManualScoreMcam == "OneEnd", "Yes", "No")) %>%
  filter(ConfidenceMcam != 2) %>%
  group_by(mainCondition) %>%
  count(wramp) %>%
  ungroup()

analyzeResults2(metricsCleanMcamOtherMcam488.Classified.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  filter(!Object %in% mcamKDmodel2_85[["trainingSets"]][["Two"]]),
                "comboGbmExtraTwo_MCAM2", "ManualScoreMcam", "mainRep")

# Check number of cells
scoringValid0901 %>% filter(is.na(Segmentation)) %>%
  filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) %>%
    group_by(mainRep) %>%
    count(ConfidenceMcam) %>%
    dplyr::mutate(nTot = sum(n), nTot - n) %>%
    ungroup() %>%
    filter(ConfidenceMcam == 2)

scoringValid0901 %>% filter(is.na(Segmentation)) %>%
  filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) %>%
  dplyr::mutate(wramp = ifelse(ManualScoreMcam == "OneEnd", "Yes", "No")) %>%
  filter(ConfidenceMcam != 2) %>%
  group_by(mainRep) %>%
  count(wramp) %>%
  ungroup()

analyzeResults2(metricsCleanMcamOtherMcam488.Classified.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  filter(!Object %in% mcamKDmodel2_85[["trainingSets"]][["Two"]]),
                "comboGbmExtraTwo_MCAM2", "ManualScoreMcam", "experimentGroup")
# Check number of cells
scoringValid0901 %>% filter(is.na(Segmentation)) %>%
  filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) %>%
    group_by(experimentGroup) %>%
    count(ConfidenceMcam) %>%
    dplyr::mutate(nTot = sum(n), nTot - n) %>%
    ungroup() %>%
    filter(ConfidenceMcam == 2)

scoringValid0901 %>% filter(is.na(Segmentation)) %>%
  filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) %>%
  dplyr::mutate(wramp = ifelse(ManualScoreMcam == "OneEnd", "Yes", "No")) %>%
  filter(ConfidenceMcam != 2) %>%
  group_by(experimentGroup) %>%
  count(wramp) %>%
  ungroup()


# Little change in % polarized cells when using 0th or 1st iteration models
metricsCleanMcamOtherMcam488.Classified.Zero %>%
  group_by(experimentGroup, mainCondition, mainRep) %>%
  count(comboGbmExtraZero_MCAM2) %>%
  dplyr::mutate(perc = n/sum(n)*100, nTot = sum(n)) %>%
  ungroup() %>%
  filter(comboGbmExtraZero_MCAM2 == "OneEnd")

metricsCleanMcamOtherMcam488.Classified.One %>%
  group_by(experimentGroup, mainCondition, mainRep) %>%
  count(comboGbmExtraOne_MCAM2) %>%
  dplyr::mutate(perc = n/sum(n)*100, nTot = sum(n)) %>%
  ungroup() %>%
  filter(comboGbmExtraOne_MCAM2 == "OneEnd")
```

Higher % of cells with "WrongObject" in false negatives
```{r}
scoringValid0901 %>%
  filter(ManualScoreMcam == "OneEnd") %>%
  count(WrongObject) %>%
  dplyr::mutate(perc = n/sum(n), nTot = sum(n))

scoringValid0901 %>%
  filter(ManualScoreMcam == "OneEnd") %>%
  merge(metricsCleanMcamOtherMcam488.Classified.Filt %>% dplyr::select(Object, comboGbmExtraTwo_MCAM2), by = "Object") %>%
  filter(comboGbmExtraTwo_MCAM2 != "OneEnd") %>%
  count(WrongObject) %>%
  dplyr::mutate(perc = n/sum(n), nTot = sum(n))
```

Classifier with Haralick features produces low sensitivity:
```{r}
mcamKDmodel1_85 <- readRDS(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ClassifiersForMcam/modelList20221104_85up", sep = ""))
metricsCleanMcamOtherMcam488.Classified.Two.Texture <- classifyCleanMetricsCombinedModels(metricsCleanMcamOtherMcam488.Classified.Filt, metricsScaled.MCAM.Filt,
                                                                                   mcamKDmodel1_85[["fittedModels"]][["gbmTwo"]], mcamKDmodel1_85[["fittedModels"]][["extraTreesTwo"]],
                                                                                   "comboGbmExtraTwo_MCAM1")

analyzeResults2(metricsCleanMcamOtherMcam488.Classified.Two.Texture %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  filter(!Object %in% mcamKDmodel1_85[["trainingSets"]][["Two"]]) %>%
                  dplyr::mutate(All = "All"),
                "comboGbmExtraTwo_MCAM1", "ManualScoreMcam", "All")

nrow(metricsCleanMcamOtherMcam488.Classified.Two.Texture %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object"))

metricsCleanMcamOtherMcam488.Classified.One.Texture <- classifyCleanMetricsCombinedModels(metricsCleanMcamOtherMcam488.Classified.Filt, metricsScaled.MCAM.Filt,
                                                                                   mcamKDmodel1_85[["fittedModels"]][["gbmOne"]], mcamKDmodel1_85[["fittedModels"]][["extraTreesOne"]],
                                                                                   "comboGbmExtraOne_MCAM1")

metricsCleanMcamOtherMcam488.Classified.Zero.Texture <- classifyCleanMetricsCombinedModels(metricsCleanMcamOtherMcam488.Classified.Filt, metricsScaled.MCAM.Filt,
                                                                                   mcamKDmodel1_85[["fittedModels"]][["gbmZero"]], mcamKDmodel1_85[["fittedModels"]][["extraTreesZero"]],
                                                                                   "comboGbmExtraZero_MCAM1")

analyzeResults2(metricsCleanMcamOtherMcam488.Classified.One.Texture %>%
                  merge(scoringValid0901%>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  filter(!Object %in% mcamKDmodel1_85[["trainingSets"]][["One"]]) %>%
                  dplyr::mutate(All = "All"),
                "comboGbmExtraOne_MCAM1", "ManualScoreMcam", "All")

nrow(metricsCleanMcamOtherMcam488.Classified.One.Texture %>%
                  merge(scoringValid0901%>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  filter(!Object %in% mcamKDmodel1_85[["trainingSets"]][["One"]]))

analyzeResults2(metricsCleanMcamOtherMcam488.Classified.Zero.Texture %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  filter(!Object %in% mcamKDmodel1_85[["trainingSets"]][["Zero"]]) %>%
                  dplyr::mutate(All = "All"),
                "comboGbmExtraZero_MCAM1", "ManualScoreMcam", "All")

nrow(metricsCleanMcamOtherMcam488.Classified.Zero.Texture %>%
                  merge(scoringValid0901%>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  filter(!Object %in% mcamKDmodel1_85[["trainingSets"]][["Zero"]]))

# Individual models
# gbm models:
analyzeResults(metricsScaled.MCAM.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  dplyr::mutate(All = "All"), mcamKDmodel1_85[["fittedModels"]][["gbmZero"]],
                "ManualScoreMcam", "All")

analyzeResults(metricsScaled.MCAM.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  dplyr::mutate(All = "All"), mcamKDmodel1_85[["fittedModels"]][["gbmOne"]],
                "ManualScoreMcam", "All")

analyzeResults(metricsScaled.MCAM.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  dplyr::mutate(All = "All"), mcamKDmodel1_85[["fittedModels"]][["gbmTwo"]],
                "ManualScoreMcam", "All")

#extraTrees models:
analyzeResults(metricsScaled.MCAM.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  dplyr::mutate(All = "All"), mcamKDmodel1_85[["fittedModels"]][["extraTreesZero"]],
                "ManualScoreMcam", "All")

analyzeResults(metricsScaled.MCAM.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  dplyr::mutate(All = "All"), mcamKDmodel1_85[["fittedModels"]][["extraTreesOne"]],
                "ManualScoreMcam", "All")

analyzeResults(metricsScaled.MCAM.Filt %>%
                  merge(scoringValid0901 %>% filter(is.na(Segmentation)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam), by = "Object") %>%
                  dplyr::mutate(All = "All"), mcamKDmodel1_85[["fittedModels"]][["extraTreesTwo"]],
                "ManualScoreMcam", "All")
```

Variable importance
```{r}
impGbm <- varImp(mcamKDmodel2_85[["fittedModels"]][["gbmTwo"]])
impExtra <- varImp(mcamKDmodel2_85[["fittedModels"]][["extraTreesTwo"]])

# write.csv(impGbm[["importance"]], paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/gbmImportantFeatures.csv", sep = ""))
# write.csv(impExtra[["importance"]], paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/extraTreesImportantFeatures.csv", sep = ""))
```

Feature importance violin plots (Supp. Fig. S7)
```{r}
# Looked at importance of features (overall for gbm or for the "OneEnd" class for extraTrees)
importantFeatures <- c("firstQuartileDistCentr2Wramp_MCAM", "medianIntensityWramp_MCAM", "brightPixWrampHalf_MCAM", "medianDistCentr2Wramp_MCAM", "medianWrampOverNot_MCAM", "areaWramp_MCAM") # First quartile distance was the most important for all classifiers except CRISPR extraTrees (still top 10). medianDist was second most important for KD classifiers, medianIntensityWramp was third most important for KD classifiers (still top 10 for CRISPR), brightPixWrampHalf" was most important for extraTrees CRISPR (top 10 for gbm CRISPR). "medianWrampOverNot" - 4th most important for extraTrees, "areaWramp" - 4th most important for gbm

impMetricsKD <- metricsScaled.MCAM.Filt %>%
  dplyr::select(all_of(importantFeatures), Object) %>%
  merge(metricsCleanMcamOtherMcam488.Classified.Filt %>% dplyr::select(Object, comboGbmExtraTwo_MCAM2), by = "Object") %>%
  arrange(Object) 
identical(metricsCleanMcamOtherMcam488.Classified.Filt$Object, impMetricsKD$Object)
identical(metricsCleanMcamOtherMcam488.Classified.Filt$comboGbmExtraTwo_MCAM2, impMetricsKD$comboGbmExtraTwo_MCAM2)

# Sample size for resubmission (removal of 20210406KD Cov2)
impMetricsKD %>% count(comboGbmExtraTwo_MCAM2)
write.csv(impMetricsKD %>% count(comboGbmExtraTwo_MCAM2), paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/FeatureFigures/SampleSize_FeatureFiguresKD.csv", sep = ""))

# Sample size for first submission
originalFilt %>% count(comboGbmExtraTwo_MCAM2)

nrow(originalFilt %>% filter(!Object %in% impMetricsKD$Object)) == (nrow(originalFilt) - nrow(impMetricsKD))
nrow(originalFilt %>% filter(Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")))
originalFilt %>% filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) %>%
  count(comboGbmExtraTwo_MCAM2)

clr = c("OneEnd" = "#e66101", "BothEnds" = "#b2abd2", "None" = "#5e3c99")
for(val in 1:6){
  p <- ggplot(impMetricsKD %>% rename(Feature = importantFeatures[val]), aes(x = comboGbmExtraTwo_MCAM2, y = Feature, color = comboGbmExtraTwo_MCAM2)) + 
    geom_violin(draw_quantiles= c(0.25,0.5,0.75),
                width = 1.6,
                alpha = 1,
                scale = "count",
                trim = F,
                linewidth = 1.2) +
    theme_classic() +
    ggtitle(importantFeatures[val]) +
    xlab("") +
    scale_color_manual(values = clr) +
    theme(text = element_text(size = 20),
          axis.text.x = element_text(angle = 90, hjust = 1),
          legend.position = "none",
          title = element_text(size = 13),
          axis.title.y = element_text(size = 20),
          axis.text = element_text(size = 20))
  
  print(p)
  # ggsave(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/TestFigures/FeatureFigures/",
  #            importantFeatures[val], ".svg", sep = ""), plot = p, width = 12, height = 15, units = "cm", dpi = 600)
}
```

Feature distribution based on manual scoring (Fig. 5B). Did not include new validation scoring in this figure.
```{r}
metricsPlotMan <- merge(metricsCleanMcamOtherMcam488.Classified.Filt, manualScoring %>% 
                          filter(is.na(Segmentation)) %>% 
                          dplyr::select(ManualScoreMcam, Object), by = "Object") %>%
  dplyr::mutate(wramp = ifelse(ManualScoreMcam == "OneEnd", "OneEnd", "None")) %>%
  dplyr::mutate(wramp = factor(wramp,  c("OneEnd", "None")),
                ManualScoreMcam = factor(ManualScoreMcam, c("OneEnd", "BothEnds", "None")))

metricsPlotMan %>% group_by(wramp) %>% count(ManualScoreMcam) %>% ungroup()
nrow(metricsPlotMan) == nrow(manualScoring)

# Sample size
metricsPlotMan %>% count(wramp) #939 One #1238 None
write.csv(metricsPlotMan %>% count(wramp), paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/FeatureFigures/SampleSize_ManualScoring.csv", sep = ""))

# Original sample size #973, 1255
merge(originalFilt, manualScoring %>% 
                          filter(is.na(Segmentation)) %>% 
                          dplyr::select(ManualScoreMcam, Object), by = "Object") %>%
  dplyr::mutate(wramp = ifelse(ManualScoreMcam == "OneEnd", "OneEnd", "None")) %>%
  filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) %>%
  count(wramp)

clr = c("OneEnd" = "#e66101", "BothEnds" = "#b2abd2", "None" = "#5e3c99")

ggplot(metricsPlotMan, aes(x = wramp, y = medianDistCentr2Wramp_MCAM, color = wramp)) + 
    geom_violin(draw_quantiles= c(0.25,0.5,0.75),
                width = 1.4,
                alpha = 1,
                scale = "count",
                trim = F,
                linewidth = 1.2) +
    theme_classic() +
    ggtitle("Median Distance \nto Brightest Object") +
    ylab("Distance (pixels)")+
    xlab("") +
    scale_color_manual(values = clr) +
    theme(text = element_text(size = 20),
          axis.text.x = element_text(angle = 90, hjust = 1),
          legend.position = "none",
          title = element_text(size = 13),
          axis.title.y = element_text(size = 20),
          axis.text = element_text(size = 20))

ggsave(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/TestFigures/FeatureFigures/medianDistCentr2Wramp_Manual_2Class", ".svg", sep = ""), width = 12, height = 15, units = "cm", dpi = 600)

ggplot(metricsPlotMan, aes(x = ManualScoreMcam, y = medianDistCentr2Wramp_MCAM, color = ManualScoreMcam)) + 
    geom_violin(draw_quantiles= c(0.25,0.5,0.75),
                width = 1.2,
                alpha = 1,
                scale = "count",
                trim = F,
                linewidth = 1.2) +
    theme_classic() +
    ggtitle("Median Distance \nto Brightest Object") +
    ylab("Distance (pixels)")+
    xlab("") +
    scale_color_manual(values = clr) +
    theme(text = element_text(size = 20),
          axis.text.x = element_text(angle = 90, hjust = 1),
          legend.position = "none",
          title = element_text(size = 13),
          axis.title.y = element_text(size = 20),
          axis.text = element_text(size = 20))

ggsave(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/TestFigures/FeatureFigures/medianDistCentr2Wramp_Manual_3Class", ".svg", sep = ""), width = 12, height = 15, units = "cm", dpi = 600)
```

Boxplots of texture features (Supp. Fig. 6D)
```{r}
plots1scaleV2 <- function(featureNames, data, chName, savePath, logOption){
  features <- str_replace(featureNames, "MCAM", chName)
  for(val in 1:length(features)){
  p <- ggplot(data %>% rename(feature = features[val])) +
    geom_jitter(aes(x=Coverslip, y = feature, color = experimentGroup), height = 0, alpha = 0.4, size = 0.5) +
    geom_boxplot(aes(x=Coverslip, y = feature, fill = experimentGroup), alpha = 0, outlier.size = .5) +
    ggtitle(features[val])+
    theme_classic() +
    theme(text = element_text(size = 13)) +
    theme(axis.text.x= element_text(size = 6, angle = 90, hjust = 1))
 
   ggsave(paste(savePath, features[val], "_expGroup.png", sep = ""), p, width = 7.5, height = 5, dpi = 600)
 
  if(logOption == T){
      p <- ggplot(data %>% rename(feature = features[val])) +
        geom_jitter(aes(x=Coverslip, y = log(feature), color = experimentGroup), height = 0, alpha = 0.4, size = 0.5) +
        geom_boxplot(aes(x=Coverslip, y = log(feature), fill = experimentGroup), alpha = 0, outlier.size = .5) +
        ggtitle(paste(features[val], "- Log"))+
        theme_classic() +
        theme(text = element_text(size = 13)) +
        theme(axis.text.x= element_text(size = 6, angle = 90, hjust = 1))
   
       ggsave(paste(savePath, features[val], "_log_expGroup.png", sep = ""), p, width = 7.5, height = 5, dpi = 600)
    }
  }
}

plots1scaleV2(colnames(metricsScaled.MCAM.Filt %>% dplyr::select(contains("Texture"))),
              metricsScaled.MCAM.Filt,
              "MCAM",
              paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/TestFigures/TexturePlots/", sep = ""), F)

# Sample size
numPerCoverslip <- metricsScaled.MCAM.Filt %>% count(Coverslip)
numPerCoverslip
sum(numPerCoverslip$n)
min(numPerCoverslip$n) # 53
max(numPerCoverslip$n) # 463

write.csv(numPerCoverslip, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/TexturePlots/SampleSize_Coverslips_TexturePlots.csv", sep = ""))
```

Compile supplemental data: compiled feature data, manual annotation for ML, and results of copolarization analysis:

Need to include validation scoring. If not reporting ambiguous labels, remove WrongObject for these columns?
```{r}
copolarizationLabeled <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ThesisAndFirstSubmission/copolarizationLabeled.csv", sep = "")) %>%
  filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2"))
# From Polarized Cells Figures notebook

# Features for supplemental table:
featuresMcamAll <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/InputForML/SupplementalMcamFeatures.csv", sep=""))

suppFeatures2 <- c("Object", "comboGbmExtraTwo_MCAM2", "ManualScoreMcam", "ConfidenceMcam", "WrongObject", "ValidationSet","copolarOther", "copolarFactin", "copolarTriple","experimentGroup", "Experiment", "Image", "stain", "mainCondition", "Condition", "mainRep", "Replicate", "Coverslip", featuresMcamAll$Feature)

# Combining manual scoring from original training and new validation set
allManualScoring <- rbind(manualScoring %>% dplyr::select(all_of(colnames(scoringValid0901))), scoringValid0901) %>%
  filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2"))
sum(duplicated(allManualScoring$Object)) # no duplicated objects
nrow(allManualScoring) - nrow(manualScoring) - nrow(scoringValid0901) # 115 cells from 20210401KD "Cov2"
nrow(manualScoring %>% filter(Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2"))) + nrow(scoringValid0901 %>% filter(Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")))

suppMetricsAll <- metricsCleanMcamOtherMcam488.Classified.Filt %>%
  merge(allManualScoring %>% dplyr::select(ManualScoreMcam, ConfidenceMcam, Object, WrongObject), by="Object", all.x = T, all.y = T) %>%
  dplyr::mutate(stain = str_remove(Condition, ".*Stain")) %>%
  dplyr::mutate(stain = str_remove(stain, "_KD.*")) %>%
  dplyr::mutate(ValidationSet = ifelse(Object %in% scoringValid0901$Object, "+", "")) %>%
  merge(copolarizationLabeled %>% dplyr::select(Object, copolarOther, copolarFactin, copolarTriple), all.x = T, all.y = T, by = "Object") %>%
  dplyr::select(all_of(suppFeatures2)) %>%
  dplyr::rename(Classification = comboGbmExtraTwo_MCAM2)

# Correct assignment of ValidationSet column
setdiff(suppMetricsAll %>% filter(ValidationSet == "+") %>% dplyr::select(Object), scoringValid0901 %>% dplyr::select(Object))
suppMetricsAll %>% count(ValidationSet)
nrow(scoringValid0901 %>% filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")))

# Check manualScoring
nrow(manualScoring %>% filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")))
all.equal(allManualScoring %>% filter(!is.na(ManualScoreMcam)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam) %>% arrange(Object),
          suppMetricsAll %>% filter(!is.na(ManualScoreMcam)) %>% dplyr::select(Object, ManualScoreMcam, ConfidenceMcam) %>% arrange(Object))

# No copolarization scoring for radixin included
suppMetricsAll %>% filter(str_detect(Condition, "StainMCAM-RDX")) %>% count(copolarOther)
suppMetricsAll %>% filter(str_detect(Condition, "StainMCAM-RDX")) %>% count(copolarFactin)
suppMetricsAll %>% filter(str_detect(Condition, "StainMCAM-RDX")) %>% count(copolarTriple)

suppMetricsAll %>% group_by(copolarOther, copolarFactin) %>% count(copolarTriple) %>% ungroup()
copolarizationLabeled %>% group_by(copolarOther, copolarFactin) %>% count(copolarTriple) %>% ungroup()

suppMetricsAll %>% count(ManualScoreMcam)
allManualScoring %>% filter(Object %in% metricsCleanMcamOtherMcam488.Classified.Filt$Object) %>% count(ManualScoreMcam)

# Check preservation of metrics data
identical(suppMetricsAll %>% dplyr::rename(comboGbmExtraTwo_MCAM2 = Classification) %>% dplyr::select(all_of(setdiff(suppFeatures2, c("copolarOther", "copolarFactin", "copolarTriple", "stain", "ManualScoreMcam", "WrongObject", "ValidationSet", "ConfidenceMcam")))) %>% arrange(Object),
          metricsCleanMcamOtherMcam488.Classified.Filt %>% dplyr::select(all_of(setdiff(suppFeatures2, c("copolarOther", "copolarFactin", "copolarTriple", "stain", "ManualScoreMcam", "WrongObject", "ValidationSet", "ConfidenceMcam")))) %>% arrange(Object))

suppMetricsAll2 <- suppMetricsAll %>% dplyr::select(-Experiment) %>% dplyr::rename(Experiment = experimentGroup) %>% arrange(Object)

identical(suppMetricsAll2 %>% dplyr::select(-Experiment), suppMetricsAll %>% arrange(Object) %>% dplyr::select(-Experiment, -experimentGroup))
unique(suppMetricsAll2$Condition)
unique(suppMetricsAll2$Experiment)
unique(suppMetricsAll2$stain)

nrow(suppMetricsAll2) == nrow(metricsCleanMcamOtherMcam488.Classified.Filt)

setdiff(featuresMcamAll$Feature, colnames(suppMetricsAll2))

write_csv(suppMetricsAll2, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/SupplementalData_ClassifiedAllMcamMetrics2_No0401Cov2_test.csv", sep = ""))

# compare original as same except for removal of Cov2 and addition of validation scores and columns
remove(test)
remove(test2)
test <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/SupplementalData_ClassifiedAllMcamMetrics2_No0401Cov2.csv", sep = ""))
test2 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ThesisAndFirstSubmission/SupplementalData_ClassifiedAllMcamMetrics2.csv", sep = ""))
test3 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/SupplementalData_ClassifiedAllMcamMetrics2_No0401Cov2_test.csv", sep = ""))

all.equal(test %>% dplyr::select(all_of(colnames(test2))), test2 %>% filter(Object %in% test$Object) %>% arrange(Object))
identical(test %>% dplyr::select(all_of(colnames(test2))) %>% filter(!Object %in% scoringValid0901$Object) %>% arrange(Object), test2 %>% filter(Object %in% test$Object) %>% filter(!Object %in% scoringValid0901$Object) %>% arrange(Object))

identical(test, test3)

identical(test %>% dplyr::select(all_of(colnames(test2))) %>% filter(!Object %in% scoringValid0901$Object) %>% arrange(Object), 
          test2 %>% filter(!Object %in% scoringValid0901$Object) %>% arrange(Object) %>% filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")))
test2 %>% filter(!Object %in% test$Object) %>% count(Coverslip)

setdiff(colnames(test), colnames(test2))
setdiff(colnames(test2), colnames(test))

remove(test)
remove(test2)
remove(test3)
```

Supplemental data: scaled features - need to rewrite to remove 20210406 "Cov2"
```{r}
metricsScaled.MCAM.Supp <- metricsScaled.MCAM.Filt %>%
  dplyr::select(-Normalization, -Experiment) %>%
  dplyr::rename(Experiment = experimentGroup) %>%
  filter(Object %in% metricsCleanMcamOtherMcam488.Classified.Filt$Object) %>%
  arrange(Object)

nrow(metricsScaled.MCAM.Supp) == nrow(metricsCleanMcamOtherMcam488.Classified.Filt)
identical(metricsScaled.MCAM.Supp$Object, suppMetricsAll2$Object)
unique(metricsScaled.MCAM.Supp$Condition)
unique(metricsScaled.MCAM.Supp$Replicate)
unique(metricsScaled.MCAM.Supp$mainCondition)
unique(metricsScaled.MCAM.Supp$Experiment)

write_csv(metricsScaled.MCAM.Supp, paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/SupplementalData_ScaledFeaturesMcam2_No0401Cov2_test.csv", sep = ""))

# Compare to original for removal of 20210406KD "Cov2" images
test <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/SupplementalData_ScaledFeaturesMcam2_No0401Cov2.csv", sep = ""))
test2 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/ThesisAndFirstSubmission/SupplementalData_ScaledFeaturesMcam2.csv", sep = ""))
identical(test, test2 %>% filter(Object %in% test$Object))
test2 %>% filter(!Object %in% test$Object) %>% count(Coverslip)
test2 %>% filter(!Object %in% test$Object) %>% count(Image)

test3 <- read.csv(paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/SupplementalData_ScaledFeaturesMcam2_No0401Cov2_test.csv", sep = ""))
identical(test, test3)

remove(test)
remove(test2)
remove(test3)
# Objects in final training set
# write.csv(mcamKDmodel2_85[["trainingSets"]][["Two"]], paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/SupplementalData_FinalTrainingSet2.csv", sep = ""))
# length(mcamKDmodel2_85[["trainingSets"]][["Two"]])
```

% of WrongObject, bothEnds:
```{r}
# % of WrongObject
# Original manual scoring
write_csv(manualScoring %>%
      filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) %>%
      filter(is.na(Segmentation)) %>%
      filter(ManualScoreMcam == "OneEnd") %>%
      count(WrongObject) %>%
      dplyr::mutate(perc = n/sum(n)*100, nTot = sum(n)) %>%
      dplyr::mutate(CorrectObject = 100-perc),
    paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/percWrongObject_OriginalScoring_No0406Cov2.csv", sep = ""))

nrow(manualScoring %>% filter(Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2"), is.na(Segmentation), ManualScoreMcam == "OneEnd"))

# % of WrongObject cells is higher for siMSN and siRDX
write_csv(manualScoring %>%
      filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) %>%
      filter(is.na(Segmentation)) %>%
      filter(ManualScoreMcam == "OneEnd") %>%
      group_by(mainCondition) %>%
      count(WrongObject) %>%
      dplyr::mutate(perc = n/sum(n)*100, nTot = sum(n)) %>%
      dplyr::mutate(CorrectObject = 100-perc) %>%
      ungroup(),
       paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/percWrongObject_OriginalScoring_Condition_No0406Cov2.csv", sep = ""))

# % of BothEnds
# Combined sets of scoring
write_csv(allManualScoring %>%
  filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) %>%
    filter(is.na(Segmentation)) %>%
    count(ManualScoreMcam) %>%
    dplyr::mutate(perc = n/sum(n)*100, nTot = sum(n)) %>%
    dplyr::mutate(CorrectObject = 100-perc),
    paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/percManualScoreMcam_combinedScoring_No0406Cov2.csv", sep = ""))

write_csv(allManualScoring %>%
  filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) %>%
    filter(is.na(Segmentation)) %>%
    group_by(mainCondition) %>%
    count(ManualScoreMcam) %>%
    dplyr::mutate(perc = n/sum(n)*100, nTot = sum(n)) %>%
    dplyr::mutate(CorrectObject = 100-perc) %>%
    ungroup(),
    paste(dirPath, "AllReplicatesAnalysisInR/AllReplicates_RevisedAnalysis_20221101/Output/Resubmission/percManualScoreMcam_combinedScoring_Condition_No0406Cov2.csv", sep = ""))

# Check
allManualScoring %>%
  filter(!Coverslip %in% c("20210406_siEZR_StainMCAM-EZR_Rep2_Cov2", "20210406_siEZR_StainMCAM-Factin_Rep2_Cov2", "20210406_siEZR_StainMCAM-Myosin_Rep2_Cov2")) %>%
    filter(is.na(Segmentation)) %>%
    count(ManualScoreMcam) %>%
    dplyr::mutate(perc = n/sum(n)*100, nTot = sum(n)) %>%
    dplyr::mutate(CorrectObject = 100-perc)

suppMetricsAll2 %>%
    filter(!is.na(ManualScoreMcam)) %>%
    count(ManualScoreMcam) %>%
    dplyr::mutate(perc = n/sum(n)*100, nTot = sum(n)) %>%
    dplyr::mutate(CorrectObject = 100-perc)

suppMetricsAll2 %>%
  filter(!is.na(ManualScoreMcam)) %>%
  filter(ValidationSet != "+") %>%
  filter(ManualScoreMcam == "OneEnd") %>%
      count(WrongObject) %>%
      dplyr::mutate(perc = n/sum(n)*100, nTot = sum(n)) %>%
      dplyr::mutate(CorrectObject = 100-perc)
```